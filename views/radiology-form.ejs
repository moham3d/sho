<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radiology Assessment Form - Al-Shorouk Radiology Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/css/custom.css" rel="stylesheet">
    <style>
        .navbar-brand {
            font-weight: bold;
        }
        .navbar-brand i {
            color: #ffffff;
        }
        .navbar-nav .nav-link {
            font-weight: 500;
            transition: color 0.3s ease;
        }
        .navbar-nav .nav-link:hover {
            color: rgba(255, 255, 255, 0.8) !important;
        }
        .navbar-nav .nav-link.active {
            color: #ffffff !important;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }
        .user-info {
            font-size: 0.9em;
            color: rgba(255, 255, 255, 0.9);
        }
        .user-role {
            font-weight: 600;
            text-transform: capitalize;
        }
        .logout-btn {
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }
        .logout-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.5);
        }
    </style>
</head>
<body class="bg-light">
    <!-- Navigation -->
    <%- include('navigation', { currentPage: 'radiology-form' }) %>

    <div class="container-fluid py-4" id="main-content" role="main">
        <div class="row justify-content-center">
            <div class="col-12 col-lg-10">
                <!-- Header -->
                <div class="text-center mb-4">
                    <h2 class="text-success mb-2">
                        <i class="fas fa-x-ray me-2" aria-hidden="true"></i>
                        Radiology Assessment Form
                    </h2>
                    <p class="text-muted">SH.MR.FRM.04 - Radiology Preparation & Assessment</p>

                    <!-- Progress Indicator -->
                    <div class="progress mt-3" style="height: 25px;">
                        <div class="progress-bar bg-success" role="progressbar" style="width: 0%" id="formProgress">
                            <span class="progress-text">0% Complete</span>
                        </div>
                    </div>
                    <small class="text-muted mt-1 d-block">
                        Form Completion Progress
                        <i class="fas fa-save text-success ms-2" title="Auto-save is enabled" aria-hidden="true"></i>
                        <small class="text-success">Auto-save active</small>
                    </small>
                </div>

                <!-- Patient Information -->
                <% if (patient) { %>
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h3 class="mb-0"><i class="fas fa-user me-2" aria-hidden="true"></i>Patient Information</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Name:</strong> <%= patient.full_name %></p>
                                <p><strong>SSN:</strong> <%= patient.ssn %></p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Medical Number:</strong> <%= patient.medical_number || 'Not provided' %></p>
                                <p><strong>Mobile:</strong> <%= patient.mobile_number || 'Not provided' %></p>
                            </div>
                        </div>
                    </div>
                </div>
                <% } %>

                <form id="radiologyForm" action="/submit-radiology-form" method="POST">
                    <% if (visit) { %>
                    <input type="hidden" name="visit_id" value="<%= visit.visit_id %>">
                    <% } %>
                    <!-- Physician and Department Info -->
                    <div class="form-section">
                        <h3><i class="fas fa-user-md me-2" aria-hidden="true"></i>Physician & Department Information</h3>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Treating Physician</label>
                                <input type="text" class="form-control" name="treating_physician" value="<%= user.fullName %>" required aria-label="Name of the treating physician">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Department</label>
                                <input type="text" class="form-control" name="department" required aria-label="Medical department name">
                            </div>
                        </div>
                    </div>

                    <!-- Patient Preparation -->
                    <div class="form-section">
                        <h3><i class="fas fa-syringe me-2" aria-hidden="true"></i>Patient Preparation</h3>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Fasting Hours</label>
                                <input type="number" class="form-control" name="fasting_hours" min="0" aria-label="Number of hours patient has been fasting">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Is Diabetic</label>
                                <select class="form-select" name="is_diabetic" aria-label="Whether the patient is diabetic">
                                    <option value="false">No</option>
                                    <option value="true">Yes</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Blood Sugar Level (mg/dL)</label>
                                <input type="number" class="form-control" name="blood_sugar_level" min="0" aria-label="Patient's blood sugar level in mg/dL">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Weight (kg)</label>
                                <input type="number" class="form-control" name="weight_kg" step="0.1" min="0" max="500" aria-label="Patient's weight in kilograms">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Height (cm)</label>
                                <input type="number" class="form-control" name="height_cm" step="0.1" min="0" max="300" aria-label="Patient's height in centimeters">
                            </div>
                        </div>
                    </div>

                    <!-- Imaging Procedure Details -->
                    <div class="form-section">
                        <h3><i class="fas fa-cogs me-2" aria-hidden="true"></i>Imaging Procedure Details</h3>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Dose Amount</label>
                                <input type="number" class="form-control" name="dose_amount" step="0.01" min="0" aria-label="Radiation dose amount">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">CTDIvol</label>
                                <input type="number" class="form-control" name="ctd1vol" step="0.01" min="0" aria-label="CT dose index volume">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">DLP</label>
                                <input type="number" class="form-control" name="dlp" step="0.01" min="0" aria-label="Dose length product">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Uses Contrast</label>
                                <select class="form-select" name="uses_contrast" aria-label="Whether the procedure uses contrast material">
                                    <option value="false">No</option>
                                    <option value="true">Yes</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Kidney Function Value</label>
                                <input type="number" class="form-control" name="kidney_function_value" step="0.01" min="0" aria-label="Patient's kidney function value">
                            </div>
                        </div>
                    </div>

                    <!-- Study Information -->
                    <div class="form-section">
                        <h3><i class="fas fa-file-medical me-2" aria-hidden="true"></i>Study Information</h3>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Is First Time</label>
                                <select class="form-select" name="is_first_time" aria-label="Whether this is the patient's first imaging study">
                                    <option value="true">Yes</option>
                                    <option value="false">No</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Requires Report</label>
                                <select class="form-select" name="requires_report" aria-label="Whether this study requires a formal report">
                                    <option value="true">Yes</option>
                                    <option value="false">No</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Diagnosis</label>
                                <textarea class="form-control" name="diagnosis" rows="3" aria-label="Patient's diagnosis information"></textarea>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Reason for Study</label>
                                <textarea class="form-control" name="reason_for_study" rows="3" required aria-label="Clinical reason for performing this imaging study"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Assessment Content -->
                    <div class="form-section">
                        <h3><i class="fas fa-stethoscope me-2" aria-hidden="true"></i>Assessment Content</h3>
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label">Findings</label>
                                <textarea class="form-control" name="findings" rows="5" required aria-label="Radiological findings from the imaging study"></textarea>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Impression</label>
                                <textarea class="form-control" name="impression" rows="4" aria-label="Radiologist's impression of the findings"></textarea>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Recommendations</label>
                                <textarea class="form-control" name="recommendations" rows="4" aria-label="Recommended follow-up actions or additional studies"></textarea>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Modality</label>
                                <select class="form-select" name="modality" aria-label="Imaging modality used for the study">
                                    <option value="">Select modality...</option>
                                    <option value="CT">CT</option>
                                    <option value="MRI">MRI</option>
                                    <option value="X-Ray">X-Ray</option>
                                    <option value="Ultrasound">Ultrasound</option>
                                    <option value="Mammography">Mammography</option>
                                    <option value="Nuclear Medicine">Nuclear Medicine</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Body Region</label>
                                <input type="text" class="form-control" name="body_region" aria-label="Body region or area examined in the study">
                            </div>
                        </div>
                    </div>

                    <!-- Treatment History -->
                    <div class="form-section">
                        <h3><i class="fas fa-history me-2" aria-hidden="true"></i>Treatment History</h3>
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label">Chemotherapy</label>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="has_chemotherapy" id="has_chemotherapy" aria-label="Patient has received chemotherapy">
                                            <label class="form-check-label" for="has_chemotherapy">Has Chemotherapy</label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <select class="form-select" name="chemo_type" aria-label="Type of chemotherapy administered">
                                            <option value="">Type...</option>
                                            <option value="tablets">Tablets</option>
                                            <option value="infusion">Infusion</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <input type="number" class="form-control" name="chemo_sessions" placeholder="Sessions" aria-label="Number of chemotherapy sessions">
                                    </div>
                                </div>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Radiotherapy</label>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="has_radiotherapy" id="has_radiotherapy" aria-label="Patient has received radiotherapy">
                                            <label class="form-check-label" for="has_radiotherapy">Has Radiotherapy</label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <input type="text" class="form-control" name="radiotherapy_site" placeholder="Site" aria-label="Radiotherapy treatment site">
                                    </div>
                                    <div class="col-md-4">
                                        <input type="number" class="form-control" name="radiotherapy_sessions" placeholder="Sessions" aria-label="Number of radiotherapy sessions">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Previous Imaging History -->
                    <div class="form-section">
                        <h3><i class="fas fa-images me-2" aria-hidden="true"></i>Previous Imaging History</h3>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="has_operations" aria-label="Patient has had surgical operations">
                                    <label class="form-check-label">Operations</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="has_endoscopy" aria-label="Patient has had endoscopy procedures">
                                    <label class="form-check-label">Endoscopy</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="has_biopsies" aria-label="Patient has had biopsy procedures">
                                    <label class="form-check-label">Biopsies</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="has_tc_mdp_bone_scan" aria-label="Patient has had TC MDP bone scan">
                                    <label class="form-check-label">TC MDP Bone Scan</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="has_tc_dtpa_kidney_scan" aria-label="Patient has had TC DTPA kidney scan">
                                    <label class="form-check-label">TC DTPA Kidney Scan</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="has_mri" aria-label="Patient has had MRI imaging">
                                    <label class="form-check-label">MRI</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="has_mammography" aria-label="Patient has had mammography">
                                    <label class="form-check-label">Mammography</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="has_ct" aria-label="Patient has had CT imaging">
                                    <label class="form-check-label">CT</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="has_xray" aria-label="Patient has had X-ray imaging">
                                    <label class="form-check-label">X-Ray</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="has_ultrasound" aria-label="Patient has had ultrasound imaging">
                                    <label class="form-check-label">Ultrasound</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Physician Signature -->
                    <div class="form-section" id="signatureSection">
                        <h3><i class="fas fa-signature me-2" aria-hidden="true"></i>Physician Signature</h3>
                        <div class="row g-3">
                            <div class="col-12">
                                <p class="text-muted mb-3">Click the button below to sign and submit this radiology assessment.</p>
                                <div id="signatureContainer">
                                    <div class="text-center">
                                        <button type="button" class="btn btn-success btn-lg" id="signFormButton">
                                            <i class="fas fa-signature me-2"></i>Sign the Form
                                        </button>
                                        <p class="text-muted mt-2">This will apply your signature and lock the form for editing</p>
                                    </div>
                                </div>
                                <div id="signedContainer" style="display: none;">
                                    <div class="alert alert-success text-center">
                                        <h4><i class="fas fa-check-circle me-2"></i>Form Signed Successfully!</h4>
                                        <p>Your signature has been applied to this assessment.</p>
                                        <img id="appliedSignature" src="" alt="Applied signature" class="border rounded mt-3" style="max-height: 80px; background: white;">
                                    </div>
                                </div>
                                <input type="hidden" name="physician_signature" id="physicianSignatureInput">
                            </div>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="text-center mt-4">
                        <button type="submit" class="btn btn-success btn-lg px-5" aria-label="Submit the completed radiology assessment">
                            <i class="fas fa-save me-2" aria-hidden="true"></i>
                            Submit Radiology Assessment
                        </button>
                        <a href="/" class="btn btn-secondary btn-lg ms-3" aria-label="Return to home page without saving">
                            <i class="fas fa-arrow-left me-2" aria-hidden="true"></i>
                            Back to Home
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/form-validation.js"></script>

    <!-- Signature Script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const signatureInput = document.getElementById('physicianSignatureInput');
            const signFormButton = document.getElementById('signFormButton');
            const signatureContainer = document.getElementById('signatureContainer');
            const signedContainer = document.getElementById('signedContainer');
            const appliedSignature = document.getElementById('appliedSignature');

            // Check if user has existing signature
            const userSignature = '<%= userSignature %>';
            const userRole = '<%= user.role %>';
            const isAdmin = userRole === 'admin';

            if (userSignature && userSignature !== 'null') {
                // User has signature, show sign button
                signatureContainer.style.display = 'block';
                signedContainer.style.display = 'none';

                // Handle sign form button
                signFormButton.addEventListener('click', function() {
                    // Show confirmation dialog
                    const confirmed = confirm('⚠️ WARNING: Signing this assessment will mark it as completed and lock it for editing.\n\nOnce signed, you will not be able to make any further changes to this assessment.\n\nAre you sure you want to sign and complete this assessment?');

                    if (!confirmed) {
                        return; // User cancelled
                    }

                    signatureInput.value = userSignature;
                    appliedSignature.src = userSignature;

                    // Show signed confirmation
                    signatureContainer.style.display = 'none';
                    signedContainer.style.display = 'block';

                    // Disable form (unless admin)
                    if (!isAdmin) {
                        disableFormAfterSignature();
                    }
                });
            } else {
                // No signature - this shouldn't happen since signatures are required on user creation
                signatureContainer.innerHTML = '<div class="alert alert-warning">No signature found. Please contact an administrator to set up your signature.</div>';
            }

            function disableFormAfterSignature() {
                // Disable all form inputs except submit buttons
                const form = document.getElementById('radiologyForm');
                const inputs = form.querySelectorAll('input:not([type="hidden"]):not([type="submit"]), select, textarea');
                inputs.forEach(input => {
                    input.disabled = true;
                    input.style.opacity = '0.6';
                });

                // Update signature section to show locked state
                const signatureSection = document.getElementById('signatureSection');
                signatureSection.innerHTML = `
                    <h3><i class="fas fa-lock me-2" aria-hidden="true"></i>Form Signed and Locked</h3>
                    <div class="alert alert-success">
                        <h4><i class="fas fa-check-circle me-2"></i>Assessment Signed Successfully!</h4>
                        <p>This radiology assessment has been signed and is now locked for editing.</p>
                        <img src="${userSignature}" alt="Applied signature" class="border rounded mt-3" style="max-height: 80px; background: white;">
                        <p class="text-muted mt-2">To make changes, please contact an administrator.</p>
                    </div>
                `;
            }

            // Form validation - check if signature exists before submission
            document.getElementById('radiologyForm').addEventListener('submit', function(e) {
                const signatureData = signatureInput.value;
                if (!signatureData || signatureData === '') {
                    e.preventDefault();
                    alert('Please sign the assessment before submitting.');
                    signFormButton.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    signFormButton.style.borderColor = '#dc3545';
                    setTimeout(() => {
                        signFormButton.style.borderColor = '';
                    }, 3000);
                    return false;
                }
            });
        });
    </script>
</body>
</html>