<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nursing Assessment Form - Al-Shorouk Radiology Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/css/custom.css" rel="stylesheet">
    <style>
        .form-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .form-section h3 {
            color: #495057;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .vital-signs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .vital-signs-grid > div {
            background: white;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #e9ecef;
        }
        .signature-pad {
            border: 2px dashed #dee2e6;
            border-radius: 5px;
        }
        canvas {
            display: block;
            margin: 0 auto;
        }
    </style>
</head>
<body class="bg-light">
    <!-- Navigation -->
    <%- include('navigation', { currentPage: 'assessment' }) %>

    <main class="container-fluid py-4" id="main-content">
        <div class="row justify-content-center">
            <div class="col-12 col-lg-10">
                <!-- Header -->
                <header class="text-center mb-4">
                    <h1 class="text-primary mb-2">
                        <i class="fas fa-user-nurse me-2" aria-hidden="true"></i>
                        Nursing Assessment Form
                    </h1>
                    <p class="text-muted">SH.MR.FRM.05 - Comprehensive Patient Screening</p>

                    <!-- Progress Indicator -->
                    <div class="progress mt-3" style="height: 25px;" role="progressbar" aria-label="Form completion progress" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
                        <div class="progress-bar bg-success" style="width: 0%" id="formProgress">
                            <span class="progress-text">0% Complete</span>
                        </div>
                    </div>
                    <small class="text-muted mt-1 d-block">
                        Form Completion Progress
                        <i class="fas fa-save text-success ms-2" title="Auto-save is enabled" aria-hidden="true"></i>
                        <small class="text-success">Auto-save active</small>
                    </small>

                    <!-- Status Announcements -->
                    <div id="formStatusAnnouncements" class="sr-only" aria-live="polite" aria-atomic="true">
                        Form progress: 0% complete. Auto-save is active.
                    </div>
                    <div id="autoSaveAnnouncements" class="sr-only" aria-live="assertive" aria-atomic="true">
                        <!-- Auto-save status announcements will appear here -->
                    </div>
                </header>

                <!-- Patient Information -->
                <div class="card mb-4 border-primary">
                    <div class="card-header bg-primary text-white">
                        <h3 class="mb-0">
                            <i class="fas fa-user me-2" aria-hidden="true"></i>Patient Information
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Full Name:</strong> <%= visit.full_name %></p>
                                <p><strong>SSN:</strong> <%= visit.patient_ssn %></p>
                                <p><strong>Medical Number:</strong> <%= visit.medical_number || 'Not provided' %></p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Mobile:</strong> <%= visit.mobile_number || 'Not provided' %></p>
                                <p><strong>Date of Birth:</strong> <%= visit.date_of_birth ? new Date(visit.date_of_birth).toLocaleDateString() : 'Not provided' %></p>
                                <p><strong>Gender:</strong> <%= visit.gender || 'Not provided' %></p>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-12">
                                <p><strong>Visit Date:</strong> <%= new Date(visit.visit_date || visit.created_at).toLocaleDateString() %></p>
                            </div>
                        </div>
                    </div>
                </div>

                <form id="nurseForm" action="/submit-nurse-form" method="POST">
                    <!-- Hidden fields -->
                    <input type="hidden" name="visit_id" value="<%= visit.visit_id %>">
                    <!-- Basic Assessment Info -->
                    <div class="form-section">
                        <h3><i class="fas fa-info-circle me-2" aria-hidden="true"></i>Basic Assessment Information</h3>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Mode of Arrival: حالة الوصول</label>
                                <select class="form-select" name="mode_of_arrival" required aria-label="Select patient's mode of arrival">
                                    <option value="walking" <%= assessment && assessment.mode_of_arrival === 'walking' ? 'selected' : '' %>>Walking - مشي</option>
                                    <option value="ambulatory" <%= assessment && assessment.mode_of_arrival === 'ambulatory' ? 'selected' : '' %>>Ambulatory - متحرك</option>
                                    <option value="wheelchair" <%= assessment && assessment.mode_of_arrival === 'wheelchair' ? 'selected' : '' %>>Wheelchair - كرسي متحرك</option>
                                    <option value="stretcher" <%= assessment && assessment.mode_of_arrival === 'stretcher' ? 'selected' : '' %>>Stretcher - نقالة</option>
                                    <option value="other" <%= assessment && assessment.mode_of_arrival === 'other' ? 'selected' : '' %>>Other - أخرى</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Age: العمر</label>
                                <input type="number" class="form-control" name="age" id="ageField" min="0" max="150" required value="<%= assessment ? assessment.age : '' %>" aria-label="Patient's age in years" aria-describedby="ageHelp">
                                <small class="text-muted" id="ageHelp">Auto-calculated from patient's date of birth</small>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Chief Complaint (الشكوي الحالية)</label>
                                <textarea class="form-control" name="chief_complaint" rows="3" required aria-label="Patient's chief complaint in Arabic and English"><%= assessment ? assessment.chief_complaint : '' %></textarea>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Accompanied by: المرافق </label>
                                <select class="form-select" name="accompanied_by" aria-label="Person accompanying the patient">
                                    <option value="">Select...</option>
                                    <option value="spouse" <%= assessment && assessment.accompanied_by === 'spouse' ? 'selected' : '' %>>Spouse - الزوج</option>
                                    <option value="relative" <%= assessment && assessment.accompanied_by === 'relative' ? 'selected' : '' %>>Relative - قريب</option>
                                    <option value="other" <%= assessment && assessment.accompanied_by === 'other' ? 'selected' : '' %>>Other - أخرى</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Language Spoken: اللغة</label>
                                <select class="form-select" name="language_spoken" aria-label="Primary language spoken by patient">
                                    <option value="arabic" <%= (!assessment || assessment.language_spoken === 'arabic') ? 'selected' : '' %>>Arabic</option>
                                    <option value="english" <%= assessment && assessment.language_spoken === 'english' ? 'selected' : '' %>>English</option>
                                    <option value="other" <%= assessment && assessment.language_spoken === 'other' ? 'selected' : '' %>>Other</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Vital Signs -->
                    <div class="form-section">
                        <h3><i class="fas fa-heartbeat me-2" aria-hidden="true"></i>Vital Signs: العلامات الحيوية</h3>
                        <div class="vital-signs-grid">
                            <div>
                                <label class="form-label">Temperature (°C): درجة الحرارة</label>
                                <input type="number" class="form-control" name="temperature_celsius" step="0.1" min="30" max="45" value="<%= assessment ? assessment.temperature_celsius : '' %>" aria-label="Body temperature in Celsius">
                            </div>
                            <div>
                                <label class="form-label">Pulse (BPM): النبض</label>
                                <input type="number" class="form-control" name="pulse_bpm" min="30" max="200" value="<%= assessment ? assessment.pulse_bpm : '' %>" aria-label="Heart rate in beats per minute">
                            </div>
                            <div>
                                <label class="form-label">Blood Pressure (Systolic): ضغط الدم (الانقباضي)</label>
                                <input type="number" class="form-control" name="blood_pressure_systolic" min="70" max="250" value="<%= assessment ? assessment.blood_pressure_systolic : '' %>" aria-label="Systolic blood pressure in mmHg">
                            </div>
                            <div>
                                <label class="form-label">Blood Pressure (Diastolic): ضغط الدم (الانبساطي)</label>
                                <input type="number" class="form-control" name="blood_pressure_diastolic" min="40" max="150" value="<%= assessment ? assessment.blood_pressure_diastolic : '' %>" aria-label="Diastolic blood pressure in mmHg">
                            </div>
                            <div>
                                <label class="form-label">Respiratory Rate: معدل التنفس</label>
                                <input type="number" class="form-control" name="respiratory_rate_per_min" min="8" max="60" value="<%= assessment ? assessment.respiratory_rate_per_min : '' %>" aria-label="Respiratory rate in breaths per minute">
                            </div>
                            <div>
                                <label class="form-label">Oxygen Saturation (%): تشبع الأكسجين</label>
                                <input type="number" class="form-control" name="oxygen_saturation_percent" step="0.1" min="70" max="100" value="<%= assessment ? assessment.oxygen_saturation_percent : '' %>" aria-label="Blood oxygen saturation percentage">
                            </div>
                            <div>
                                <label class="form-label">Blood Sugar (mg/dL): سكر الدم</label>
                                <input type="number" class="form-control" name="blood_sugar_mg_dl" min="0" value="<%= assessment ? assessment.blood_sugar_mg_dl : '' %>" aria-label="Blood glucose level in mg/dL">
                            </div>
                            <div>
                                <label class="form-label">Weight (kg): الوزن</label>
                                <input type="number" class="form-control" name="weight_kg" step="0.1" min="0" max="500" value="<%= assessment ? assessment.weight_kg : '' %>" aria-label="Patient weight in kilograms">
                            </div>
                            <div>
                                <label class="form-label">Height (cm): الطول</label>
                                <input type="number" class="form-control" name="height_cm" step="0.1" min="0" max="300" value="<%= assessment ? assessment.height_cm : '' %>" aria-label="Patient height in centimeters">
                            </div>
                        </div>
                    </div>

                    <!-- Psychosocial Assessment -->
                    <div class="form-section">
                        <h3><i class="fas fa-brain me-2" aria-hidden="true"></i>Psychosocial Assessment: التقييم النفسي الاجتماعي</h3>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Psychological Problem: المشكلة النفسية</label>
                                <select class="form-select" name="psychological_problem" aria-label="Patient's current psychological condition">
                                    <option value="none" <%= assessment && assessment.psychological_problem === 'none' ? 'selected' : '' %>>None: لا شيء</option>
                                    <option value="depressed" <%= assessment && assessment.psychological_problem === 'depressed' ? 'selected' : '' %>>Depressed: مكتئب</option>
                                    <option value="agitated" <%= assessment && assessment.psychological_problem === 'agitated' ? 'selected' : '' %>>Agitated: مضطرب</option>
                                    <option value="anxious" <%= assessment && assessment.psychological_problem === 'anxious' ? 'selected' : '' %>>Anxious: قلق</option>
                                    <option value="isolated" <%= assessment && assessment.psychological_problem === 'isolated' ? 'selected' : '' %>>Isolated: منعزل</option>
                                    <option value="confused" <%= assessment && assessment.psychological_problem === 'confused' ? 'selected' : '' %>>Confused: مرتبك</option>
                                    <option value="other" <%= assessment && assessment.psychological_problem === 'other' ? 'selected' : '' %>>Other: أخرى</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Smoker: مدخن</label>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" name="is_smoker" <%= assessment && assessment.is_smoker ? 'checked' : '' %> aria-label="Patient is a smoker">
                                </div>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Allergies: الحساسية</label>
                                <div class="row">
                                    <div class="col-md-4">
                                        <% if (assessment && (assessment.has_allergies || assessment.medication_allergies || assessment.food_allergies || assessment.other_allergies)) { %>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="has_allergies" id="has_allergies" <%= assessment && assessment.has_allergies ? 'checked' : '' %> aria-label="Patient has allergies">
                                            <label class="form-check-label" for="has_allergies">Has Allergies: لديه حساسية</label>
                                        </div>
                                        <% } %>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <input type="text" class="form-control" name="medication_allergies" placeholder="Medication allergies: لديه حساسية تجاه الأدوية" value="<%= assessment ? assessment.medication_allergies : '' %>" aria-label="List of medication allergies">
                                    <input type="text" class="form-control mt-2" name="food_allergies" placeholder="Food allergies: لديه حساسية تجاه الطعام" value="<%= assessment ? assessment.food_allergies : '' %>" aria-label="List of food allergies">
                                    <input type="text" class="form-control mt-2" name="other_allergies" placeholder="Other allergies: حساسية أخرى" value="<%= assessment ? assessment.other_allergies : '' %>" aria-label="List of other allergies">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Nutritional Screening -->
                    <div class="form-section">
                        <h3><i class="fas fa-utensils me-2" aria-hidden="true"></i>Nutritional Screening: تقييم التغذية</h3>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Diet Type: نوع الحمية</label>
                                <select class="form-select" name="diet_type" aria-label="Patient's prescribed diet type">
                                    <option value="regular" <%= (!assessment || assessment.diet_type === 'regular') ? 'selected' : '' %>>Regular: عادي</option>
                                    <option value="special" <%= assessment && assessment.diet_type === 'special' ? 'selected' : '' %>>Special: خاص</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Appetite: الشهية</label>
                                <select class="form-select" name="appetite" aria-label="Patient's current appetite level">
                                    <option value="good" <%= assessment && assessment.appetite === 'good' ? 'selected' : '' %>>Good: جيد</option>
                                    <option value="poor" <%= assessment && assessment.appetite === 'poor' ? 'selected' : '' %>>Poor: ضعيف</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Nutritional Issues: مشاكل التغذية</label>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="has_git_problems" <%= assessment && assessment.has_git_problems ? 'checked' : '' %> aria-label="Patient has gastrointestinal problems">
                                            <label class="form-check-label">GI Problems: مشاكل الجهاز الهضمي</label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="has_weight_loss" <%= assessment && assessment.has_weight_loss ? 'checked' : '' %> aria-label="Patient has experienced weight loss">
                                            <label class="form-check-label">Weight Loss: فقدان الوزن</label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="has_weight_gain" <%= assessment && assessment.has_weight_gain ? 'checked' : '' %> aria-label="Patient has experienced weight gain">
                                            <label class="form-check-label">Weight Gain: زيادة الوزن</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Functional Assessment -->
                    <div class="form-section">
                        <h3><i class="fas fa-wheelchair me-2" aria-hidden="true"></i>Functional Assessment: التقييم الوظيفي</h3>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Feeding Status: حالة التغذية</label>
                                <select class="form-select" name="feeding_status" aria-label="Patient's feeding independence level">
                                    <option value="independent" <%= assessment && assessment.feeding_status === 'independent' ? 'selected' : '' %>>Independent: مستقل</option>
                                    <option value="needs_supervision" <%= assessment && assessment.feeding_status === 'needs_supervision' ? 'selected' : '' %>>Needs Supervision: يحتاج إلى إشراف</option>
                                    <option value="totally_dependent" <%= assessment && assessment.feeding_status === 'totally_dependent' ? 'selected' : '' %>>Totally Dependent: يعتمد كليًا</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Hygiene Status: حالة النظافة</label>
                                <select class="form-select" name="hygiene_status" aria-label="Patient's hygiene independence level">
                                    <option value="independent" <%= assessment && assessment.hygiene_status === 'independent' ? 'selected' : '' %>>Independent: مستقل</option>
                                    <option value="needs_supervision" <%= assessment && assessment.hygiene_status === 'needs_supervision' ? 'selected' : '' %>>Needs Supervision: يحتاج إلى إشراف</option>
                                    <option value="totally_dependent" <%= assessment && assessment.hygiene_status === 'totally_dependent' ? 'selected' : '' %>>Totally Dependent: يعتمد كليًا</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Toileting Status: حالة التبرز</label>
                                <select class="form-select" name="toileting_status" aria-label="Patient's toileting independence level">
                                    <option value="independent" <%= assessment && assessment.toileting_status === 'independent' ? 'selected' : '' %>>Independent: مستقل</option>
                                    <option value="needs_supervision" <%= assessment && assessment.toileting_status === 'needs_supervision' ? 'selected' : '' %>>Needs Supervision: يحتاج إلى إشراف</option>
                                    <option value="totally_dependent" <%= assessment && assessment.toileting_status === 'totally_dependent' ? 'selected' : '' %>>Totally Dependent: يعتمد كليًا</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Ambulation Status: حالة المشي</label>
                                <select class="form-select" name="ambulation_status" aria-label="Patient's walking independence level">
                                    <option value="independent" <%= assessment && assessment.ambulation_status === 'independent' ? 'selected' : '' %>>Independent: مستقل</option>
                                    <option value="needs_supervision" <%= assessment && assessment.ambulation_status === 'needs_supervision' ? 'selected' : '' %>>Needs Supervision: يحتاج إلى إشراف</option>
                                    <option value="totally_dependent" <%= assessment && assessment.ambulation_status === 'totally_dependent' ? 'selected' : '' %>>Totally Dependent: يعتمد كليًا</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Assistive Equipment: الأجهزة المساعدة</label>
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="uses_walker" <%= assessment && assessment.uses_walker ? 'checked' : '' %> aria-label="Patient uses a walker">
                                            <label class="form-check-label">Walker: مشاية</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="uses_wheelchair" <%= assessment && assessment.uses_wheelchair ? 'checked' : '' %> aria-label="Patient uses a wheelchair">
                                            <label class="form-check-label">Wheelchair: كرسي متحرك</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="uses_transfer_device" <%= assessment && assessment.uses_transfer_device ? 'checked' : '' %> aria-label="Patient uses a transfer device">
                                            <label class="form-check-label">Transfer Device: جهاز نقل</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="uses_other_equipment" <%= assessment && assessment.uses_other_equipment ? 'checked' : '' %> aria-label="Patient uses other assistive equipment">
                                            <label class="form-check-label">Other: أخرى</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pain Assessment -->
                    <div class="form-section">
                        <h3><i class="fas fa-exclamation-triangle me-2" aria-hidden="true"></i>Pain Assessment</h3>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Pain Intensity (0-10)</label>
                                <input type="range" class="form-range" name="pain_intensity" min="0" max="10" value="<%= assessment ? assessment.pain_intensity : 0 %>" oninput="this.nextElementSibling.value = this.value" aria-label="Pain intensity level" aria-valuemin="0" aria-valuemax="10" aria-valuenow="<%= assessment ? assessment.pain_intensity : 0 %>">
                                <output><%= assessment ? assessment.pain_intensity : 0 %></output>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Pain Location</label>
                                <input type="text" class="form-control" name="pain_location" value="<%= assessment ? assessment.pain_location : '' %>" aria-label="Location of patient's pain">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Pain Frequency</label>
                                <input type="text" class="form-control" name="pain_frequency" value="<%= assessment ? assessment.pain_frequency : '' %>" aria-label="Frequency of patient's pain">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Pain Character</label>
                                <input type="text" class="form-control" name="pain_character" value="<%= assessment ? assessment.pain_character : '' %>" aria-label="Description of patient's pain character">
                            </div>
                        </div>
                    </div>

                    <!-- Morse Fall Scale Assessment -->
                    <div class="form-section" id="morseFallScaleSection">
                        <h3><i class="fas fa-exclamation-triangle me-2" aria-hidden="true"></i>Morse Fall Scale Assessment: مقياس مورز لخطر السقوط</h3>
                        <div class="alert alert-info">
                            <strong>Fall Risk Categories:</strong> 0-10 (Low), 11-20 (Medium), 21-30 (High), 31+ (Very High)
                        </div>
                        <div class="row g-3">
                            <!-- History of Falling -->
                            <div class="col-md-6">
                                <label class="form-label fw-bold">1. History of Falling: تاريخ السقوط</label>
                                <div class="form-check">
                                    <input class="form-check-input morse-radio" type="radio" name="morse_history_falling" value="0" <%= assessment && assessment.morse_history_falling === '0' ? 'checked' : '' %> data-score="0" aria-label="No history of falling">
                                    <label class="form-check-label">No (0 points): لا</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input morse-radio" type="radio" name="morse_history_falling" value="25" <%= assessment && assessment.morse_history_falling === '25' ? 'checked' : '' %> data-score="25" aria-label="Yes history of falling">
                                    <label class="form-check-label">Yes (25 points): نعم</label>
                                </div>
                            </div>

                            <!-- Secondary Diagnosis -->
                            <div class="col-md-6">
                                <label class="form-label fw-bold">2. Secondary Diagnosis: تشخيص ثانوي</label>
                                <div class="form-check">
                                    <input class="form-check-input morse-radio" type="radio" name="morse_secondary_diagnosis" value="0" <%= assessment && assessment.morse_secondary_diagnosis === '0' ? 'checked' : '' %> data-score="0" aria-label="No secondary diagnosis">
                                    <label class="form-check-label">No (0 points): لا</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input morse-radio" type="radio" name="morse_secondary_diagnosis" value="15" <%= assessment && assessment.morse_secondary_diagnosis === '15' ? 'checked' : '' %> data-score="15" aria-label="Yes secondary diagnosis">
                                    <label class="form-check-label">Yes (15 points): نعم</label>
                                </div>
                            </div>

                            <!-- Ambulatory Aid -->
                            <div class="col-md-6">
                                <label class="form-label fw-bold">3. Ambulatory Aid: أداة المشي المساعدة</label>
                                <div class="form-check">
                                    <input class="form-check-input morse-radio" type="radio" name="morse_ambulatory_aid" value="0" <%= assessment && assessment.morse_ambulatory_aid === '0' ? 'checked' : '' %> data-score="0" aria-label="No ambulatory aid">
                                    <label class="form-check-label">None (0 points): لا شيء</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input morse-radio" type="radio" name="morse_ambulatory_aid" value="15" <%= assessment && assessment.morse_ambulatory_aid === '15' ? 'checked' : '' %> data-score="15" aria-label="Cane or crutch">
                                    <label class="form-check-label">Cane/Crutch (15 points): عصا/عكاز</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input morse-radio" type="radio" name="morse_ambulatory_aid" value="20" <%= assessment && assessment.morse_ambulatory_aid === '20' ? 'checked' : '' %> data-score="20" aria-label="Walker">
                                    <label class="form-check-label">Walker (20 points): مشاية</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input morse-radio" type="radio" name="morse_ambulatory_aid" value="30" <%= assessment && assessment.morse_ambulatory_aid === '30' ? 'checked' : '' %> data-score="30" aria-label="Furniture for support">
                                    <label class="form-check-label">Furniture (30 points): الأثاث</label>
                                </div>
                            </div>

                            <!-- IV Therapy -->
                            <div class="col-md-6">
                                <label class="form-label fw-bold">4. IV Therapy: علاج وريدي</label>
                                <div class="form-check">
                                    <input class="form-check-input morse-radio" type="radio" name="morse_iv_therapy" value="0" <%= assessment && assessment.morse_iv_therapy === '0' ? 'checked' : '' %> data-score="0" aria-label="No IV therapy">
                                    <label class="form-check-label">No (0 points): لا</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input morse-radio" type="radio" name="morse_iv_therapy" value="20" <%= assessment && assessment.morse_iv_therapy === '20' ? 'checked' : '' %> data-score="20" aria-label="Yes IV therapy">
                                    <label class="form-check-label">Yes (20 points): نعم</label>
                                </div>
                            </div>

                            <!-- Gait -->
                            <div class="col-md-6">
                                <label class="form-label fw-bold">5. Gait: المشي</label>
                                <div class="form-check">
                                    <input class="form-check-input morse-radio" type="radio" name="morse_gait" value="0" <%= assessment && assessment.morse_gait === '0' ? 'checked' : '' %> data-score="0" aria-label="Normal gait">
                                    <label class="form-check-label">Normal (0 points): طبيعي</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input morse-radio" type="radio" name="morse_gait" value="10" <%= assessment && assessment.morse_gait === '10' ? 'checked' : '' %> data-score="10" aria-label="Weak gait">
                                    <label class="form-check-label">Weak (10 points): ضعيف</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input morse-radio" type="radio" name="morse_gait" value="20" <%= assessment && assessment.morse_gait === '20' ? 'checked' : '' %> data-score="20" aria-label="Impaired gait">
                                    <label class="form-check-label">Impaired (20 points): معاق</label>
                                </div>
                            </div>

                            <!-- Mental Status -->
                            <div class="col-md-6">
                                <label class="form-label fw-bold">6. Mental Status: الحالة العقلية</label>
                                <div class="form-check">
                                    <input class="form-check-input morse-radio" type="radio" name="morse_mental_status" value="0" <%= assessment && assessment.morse_mental_status === '0' ? 'checked' : '' %> data-score="0" aria-label="Oriented mental status">
                                    <label class="form-check-label">Oriented (0 points): واعي</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input morse-radio" type="radio" name="morse_mental_status" value="15" <%= assessment && assessment.morse_mental_status === '15' ? 'checked' : '' %> data-score="15" aria-label="Confused or impaired mental status">
                                    <label class="form-check-label">Confused/Impaired (15 points): مرتبك/معاق</label>
                                </div>
                            </div>

                            <!-- Total Score Display -->
                            <div class="col-12">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h5 class="card-title">Morse Fall Scale Total Score</h5>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <h2 class="text-primary" id="morseTotalScore">0</h2>
                                                <p class="mb-0">Total Points</p>
                                            </div>
                                            <div class="col-md-6">
                                                <h4 class="text-warning" id="morseRiskLevel">Low Risk</h4>
                                                <p class="mb-0">Risk Category</p>
                                            </div>
                                        </div>
                                        <input type="hidden" name="morse_total_score" id="morseTotalScoreInput" value="<%= assessment ? assessment.morse_total_score : 0 %>">
                                        <input type="hidden" name="morse_risk_level" id="morseRiskLevelInput" value="<%= assessment ? assessment.morse_risk_level : 'Low Risk' %>">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pediatric Fall Risk Assessment -->
                    <div class="form-section" id="pediatricFallRiskSection" style="display: none;">
                        <h3><i class="fas fa-child me-2" aria-hidden="true"></i>Pediatric Fall Risk Assessment: تقييم خطر السقوط للأطفال</h3>
                        <div class="alert alert-info">
                            <strong>This assessment is shown for patients under 18 years old.</strong>
                        </div>
                        <div class="row g-3">
                            <!-- Developmental Stage -->
                            <div class="col-md-6">
                                <label class="form-label fw-bold">1. Developmental Stage: مرحلة النمو</label>
                                <div class="form-check">
                                    <input class="form-check-input pediatric-radio" type="radio" name="pediatric_developmental_stage" value="0" <%= assessment && assessment.pediatric_developmental_stage === '0' ? 'checked' : '' %> data-score="0" aria-label="Age appropriate development">
                                    <label class="form-check-label">Age Appropriate (0 points): مناسب للعمر</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input pediatric-radio" type="radio" name="pediatric_developmental_stage" value="1" <%= assessment && assessment.pediatric_developmental_stage === '1' ? 'checked' : '' %> data-score="1" aria-label="Delayed development">
                                    <label class="form-check-label">Delayed (1 point): متأخر</label>
                                </div>
                            </div>

                            <!-- Activity Level -->
                            <div class="col-md-6">
                                <label class="form-label fw-bold">2. Activity Level: مستوى النشاط</label>
                                <div class="form-check">
                                    <input class="form-check-input pediatric-radio" type="radio" name="pediatric_activity_level" value="0" <%= assessment && assessment.pediatric_activity_level === '0' ? 'checked' : '' %> data-score="0" aria-label="Normal activity level">
                                    <label class="form-check-label">Normal (0 points): طبيعي</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input pediatric-radio" type="radio" name="pediatric_activity_level" value="1" <%= assessment && assessment.pediatric_activity_level === '1' ? 'checked' : '' %> data-score="1" aria-label="Increased activity level">
                                    <label class="form-check-label">Increased (1 point): مرتفع</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input pediatric-radio" type="radio" name="pediatric_activity_level" value="2" <%= assessment && assessment.pediatric_activity_level === '2' ? 'checked' : '' %> data-score="2" aria-label="Decreased activity level">
                                    <label class="form-check-label">Decreased (2 points): منخفض</label>
                                </div>
                            </div>

                            <!-- Medication Use -->
                            <div class="col-md-6">
                                <label class="form-label fw-bold">3. Medication Use: استخدام الأدوية</label>
                                <div class="form-check">
                                    <input class="form-check-input pediatric-radio" type="radio" name="pediatric_medication_use" value="0" <%= assessment && assessment.pediatric_medication_use === '0' ? 'checked' : '' %> data-score="0" aria-label="No medications affecting balance">
                                    <label class="form-check-label">None (0 points): لا شيء</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input pediatric-radio" type="radio" name="pediatric_medication_use" value="1" <%= assessment && assessment.pediatric_medication_use === '1' ? 'checked' : '' %> data-score="1" aria-label="One medication affecting balance">
                                    <label class="form-check-label">One (1 point): واحد</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input pediatric-radio" type="radio" name="pediatric_medication_use" value="2" <%= assessment && assessment.pediatric_medication_use === '2' ? 'checked' : '' %> data-score="2" aria-label="Multiple medications affecting balance">
                                    <label class="form-check-label">Multiple (2 points): متعدد</label>
                                </div>
                            </div>

                            <!-- Environmental Factors -->
                            <div class="col-md-6">
                                <label class="form-label fw-bold">4. Environmental Factors: العوامل البيئية</label>
                                <div class="form-check">
                                    <input class="form-check-input pediatric-radio" type="radio" name="pediatric_environmental_factors" value="0" <%= assessment && assessment.pediatric_environmental_factors === '0' ? 'checked' : '' %> data-score="0" aria-label="Safe environment">
                                    <label class="form-check-label">Safe (0 points): آمن</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input pediatric-radio" type="radio" name="pediatric_environmental_factors" value="1" <%= assessment && assessment.pediatric_environmental_factors === '1' ? 'checked' : '' %> data-score="1" aria-label="Moderate risk environment">
                                    <label class="form-check-label">Moderate Risk (1 point): خطر متوسط</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input pediatric-radio" type="radio" name="pediatric_environmental_factors" value="2" <%= assessment && assessment.pediatric_environmental_factors === '2' ? 'checked' : '' %> data-score="2" aria-label="High risk environment">
                                    <label class="form-check-label">High Risk (2 points): خطر عالي</label>
                                </div>
                            </div>

                            <!-- Previous Falls -->
                            <div class="col-md-6">
                                <label class="form-label fw-bold">5. Previous Falls: السقوط السابق</label>
                                <div class="form-check">
                                    <input class="form-check-input pediatric-radio" type="radio" name="pediatric_previous_falls" value="0" <%= assessment && assessment.pediatric_previous_falls === '0' ? 'checked' : '' %> data-score="0" aria-label="No previous falls">
                                    <label class="form-check-label">None (0 points): لا شيء</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input pediatric-radio" type="radio" name="pediatric_previous_falls" value="1" <%= assessment && assessment.pediatric_previous_falls === '1' ? 'checked' : '' %> data-score="1" aria-label="One previous fall">
                                    <label class="form-check-label">One (1 point): واحد</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input pediatric-radio" type="radio" name="pediatric_previous_falls" value="2" <%= assessment && assessment.pediatric_previous_falls === '2' ? 'checked' : '' %> data-score="2" aria-label="Multiple previous falls">
                                    <label class="form-check-label">Multiple (2 points): متعدد</label>
                                </div>
                            </div>

                            <!-- Cognitive/Behavioral Factors -->
                            <div class="col-md-6">
                                <label class="form-label fw-bold">6. Cognitive/Behavioral Factors: العوامل المعرفية/السلوكية</label>
                                <div class="form-check">
                                    <input class="form-check-input pediatric-radio" type="radio" name="pediatric_cognitive_factors" value="0" <%= assessment && assessment.pediatric_cognitive_factors === '0' ? 'checked' : '' %> data-score="0" aria-label="Normal cognitive function">
                                    <label class="form-check-label">Normal (0 points): طبيعي</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input pediatric-radio" type="radio" name="pediatric_cognitive_factors" value="1" <%= assessment && assessment.pediatric_cognitive_factors === '1' ? 'checked' : '' %> data-score="1" aria-label="Mild impairment">
                                    <label class="form-check-label">Mild Impairment (1 point): ضعف خفيف</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input pediatric-radio" type="radio" name="pediatric_cognitive_factors" value="2" <%= assessment && assessment.pediatric_cognitive_factors === '2' ? 'checked' : '' %> data-score="2" aria-label="Significant impairment">
                                    <label class="form-check-label">Significant Impairment (2 points): ضعف كبير</label>
                                </div>
                            </div>

                            <!-- Total Score Display -->
                            <div class="col-12">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h5 class="card-title">Pediatric Fall Risk Total Score</h5>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <h2 class="text-primary" id="pediatricTotalScore">0</h2>
                                                <p class="mb-0">Total Points</p>
                                            </div>
                                            <div class="col-md-6">
                                                <h4 class="text-warning" id="pediatricRiskLevel">Low Risk</h4>
                                                <p class="mb-0">Risk Category</p>
                                            </div>
                                        </div>
                                        <input type="hidden" name="pediatric_total_score" id="pediatricTotalScoreInput" value="<%= assessment ? assessment.pediatric_total_score : 0 %>">
                                        <input type="hidden" name="pediatric_risk_level" id="pediatricRiskLevelInput" value="<%= assessment ? assessment.pediatric_risk_level : 'Low Risk' %>">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Elderly Assessment Evaluation -->
                    <div class="form-section" id="elderlyAssessmentSection" style="display: none;">
                        <h3><i class="fas fa-user-plus me-2" aria-hidden="true"></i>Elderly Assessment Evaluation: تقييم كبار السن</h3>
                        <div class="alert alert-info">
                            <strong>This assessment is shown for patients 65 years and older.</strong>
                        </div>

                        <!-- Cognitive Screening -->
                        <div class="row g-3 mb-4">
                            <div class="col-12">
                                <h5 class="text-primary border-bottom pb-2"><i class="fas fa-brain me-2"></i>Cognitive Screening: فحص الإدراك</h5>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Orientation: التوجه</label>
                                <div class="form-check">
                                    <input class="form-check-input elderly-radio" type="radio" name="elderly_orientation" value="0" <%= assessment && assessment.elderly_orientation === '0' ? 'checked' : '' %> data-score="0" aria-label="Oriented to time, place, and person">
                                    <label class="form-check-label">Oriented (0 points): واعي</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input elderly-radio" type="radio" name="elderly_orientation" value="1" <%= assessment && assessment.elderly_orientation === '1' ? 'checked' : '' %> data-score="1" aria-label="Disoriented">
                                    <label class="form-check-label">Disoriented (1 point): غير واعي</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Memory: الذاكرة</label>
                                <div class="form-check">
                                    <input class="form-check-input elderly-radio" type="radio" name="elderly_memory" value="0" <%= assessment && assessment.elderly_memory === '0' ? 'checked' : '' %> data-score="0" aria-label="Intact memory">
                                    <label class="form-check-label">Intact (0 points): سليمة</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input elderly-radio" type="radio" name="elderly_memory" value="1" <%= assessment && assessment.elderly_memory === '1' ? 'checked' : '' %> data-score="1" aria-label="Impaired memory">
                                    <label class="form-check-label">Impaired (1 point): ضعيفة</label>
                                </div>
                            </div>
                        </div>

                        <!-- Functional Assessment -->
                        <div class="row g-3 mb-4">
                            <div class="col-12">
                                <h5 class="text-primary border-bottom pb-2"><i class="fas fa-hands me-2"></i>Functional Assessment (ADLs): التقييم الوظيفي</h5>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Bathing: الاستحمام</label>
                                <select class="form-select elderly-select" name="elderly_bathing" aria-label="Bathing independence level">
                                    <option value="0" <%= assessment && assessment.elderly_bathing === '0' ? 'selected' : '' %> data-score="0">Independent (0 points): مستقل</option>
                                    <option value="1" <%= assessment && assessment.elderly_bathing === '1' ? 'selected' : '' %> data-score="1">Needs Help (1 point): يحتاج مساعدة</option>
                                    <option value="2" <%= assessment && assessment.elderly_bathing === '2' ? 'selected' : '' %> data-score="2">Dependent (2 points): يعتمد كليًا</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Dressing: اللبس</label>
                                <select class="form-select elderly-select" name="elderly_dressing" aria-label="Dressing independence level">
                                    <option value="0" <%= assessment && assessment.elderly_dressing === '0' ? 'selected' : '' %> data-score="0">Independent (0 points): مستقل</option>
                                    <option value="1" <%= assessment && assessment.elderly_dressing === '1' ? 'selected' : '' %> data-score="1">Needs Help (1 point): يحتاج مساعدة</option>
                                    <option value="2" <%= assessment && assessment.elderly_dressing === '2' ? 'selected' : '' %> data-score="2">Dependent (2 points): يعتمد كليًا</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Toileting: التبرز</label>
                                <select class="form-select elderly-select" name="elderly_toileting" aria-label="Toileting independence level">
                                    <option value="0" <%= assessment && assessment.elderly_toileting === '0' ? 'selected' : '' %> data-score="0">Independent (0 points): مستقل</option>
                                    <option value="1" <%= assessment && assessment.elderly_toileting === '1' ? 'selected' : '' %> data-score="1">Needs Help (1 point): يحتاج مساعدة</option>
                                    <option value="2" <%= assessment && assessment.elderly_toileting === '2' ? 'selected' : '' %> data-score="2">Dependent (2 points): يعتمد كليًا</option>
                                </select>
                            </div>
                        </div>

                        <!-- Medication Review -->
                        <div class="row g-3 mb-4">
                            <div class="col-12">
                                <h5 class="text-primary border-bottom pb-2"><i class="fas fa-pills me-2"></i>Medication Review: مراجعة الأدوية</h5>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Number of Medications: عدد الأدوية</label>
                                <select class="form-select elderly-select" name="elderly_medication_count" aria-label="Number of medications">
                                    <option value="0" <%= assessment && assessment.elderly_medication_count === '0' ? 'selected' : '' %> data-score="0">0-4 medications (0 points): 0-4 أدوية</option>
                                    <option value="1" <%= assessment && assessment.elderly_medication_count === '1' ? 'selected' : '' %> data-score="1">5-9 medications (1 point): 5-9 أدوية</option>
                                    <option value="2" <%= assessment && assessment.elderly_medication_count === '2' ? 'selected' : '' %> data-score="2">10+ medications (2 points): 10+ أدوية</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">High-Risk Medications: الأدوية عالية الخطورة</label>
                                <div class="form-check">
                                    <input class="form-check-input elderly-checkbox" type="checkbox" name="elderly_high_risk_meds" <%= assessment && assessment.elderly_high_risk_meds ? 'checked' : '' %> data-score="1" aria-label="Taking high-risk medications">
                                    <label class="form-check-label">Taking high-risk medications (1 point): يتناول أدوية عالية الخطورة</label>
                                </div>
                            </div>
                        </div>

                        <!-- Geriatric Syndromes -->
                        <div class="row g-3 mb-4">
                            <div class="col-12">
                                <h5 class="text-primary border-bottom pb-2"><i class="fas fa-exclamation-triangle me-2"></i>Geriatric Syndromes: متلازمات الشيخوخة</h5>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input elderly-checkbox" type="checkbox" name="elderly_falls" <%= assessment && assessment.elderly_falls ? 'checked' : '' %> data-score="1" aria-label="History of falls">
                                    <label class="form-check-label">Recent Falls (1 point): سقوط حديث</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input elderly-checkbox" type="checkbox" name="elderly_incontinence" <%= assessment && assessment.elderly_incontinence ? 'checked' : '' %> data-score="1" aria-label="Urinary incontinence">
                                    <label class="form-check-label">Incontinence (1 point): سلس البول</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input elderly-checkbox" type="checkbox" name="elderly_delirium" <%= assessment && assessment.elderly_delirium ? 'checked' : '' %> data-score="2" aria-label="Delirium">
                                    <label class="form-check-label">Delirium (2 points): هلوسة</label>
                                </div>
                            </div>
                        </div>

                        <!-- Social Support -->
                        <div class="row g-3 mb-4">
                            <div class="col-12">
                                <h5 class="text-primary border-bottom pb-2"><i class="fas fa-users me-2"></i>Social Support: الدعم الاجتماعي</h5>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Living Situation: وضع المعيشة</label>
                                <select class="form-select elderly-select" name="elderly_living_situation" aria-label="Living situation">
                                    <option value="0" <%= assessment && assessment.elderly_living_situation === '0' ? 'selected' : '' %> data-score="0">Lives with family/support (0 points): يعيش مع العائلة/الدعم</option>
                                    <option value="1" <%= assessment && assessment.elderly_living_situation === '1' ? 'selected' : '' %> data-score="1">Lives alone (1 point): يعيش وحده</option>
                                    <option value="2" <%= assessment && assessment.elderly_living_situation === '2' ? 'selected' : '' %> data-score="2">Nursing home/institution (2 points): دار رعاية/مؤسسة</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Social Support Available: الدعم الاجتماعي المتاح</label>
                                <select class="form-select elderly-select" name="elderly_social_support" aria-label="Social support availability">
                                    <option value="0" <%= assessment && assessment.elderly_social_support === '0' ? 'selected' : '' %> data-score="0">Strong support system (0 points): نظام دعم قوي</option>
                                    <option value="1" <%= assessment && assessment.elderly_social_support === '1' ? 'selected' : '' %> data-score="1">Limited support (1 point): دعم محدود</option>
                                    <option value="2" <%= assessment && assessment.elderly_social_support === '2' ? 'selected' : '' %> data-score="2">No support system (2 points): لا يوجد نظام دعم</option>
                                </select>
                            </div>
                        </div>

                        <!-- Total Score Display -->
                        <div class="row g-3">
                            <div class="col-12">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h5 class="card-title">Elderly Assessment Total Score</h5>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <h2 class="text-primary" id="elderlyTotalScore">0</h2>
                                                <p class="mb-0">Total Points</p>
                                            </div>
                                            <div class="col-md-6">
                                                <h4 class="text-warning" id="elderlyRiskLevel">Low Risk</h4>
                                                <p class="mb-0">Risk Category</p>
                                            </div>
                                        </div>
                                        <input type="hidden" name="elderly_total_score" id="elderlyTotalScoreInput" value="<%= assessment ? assessment.elderly_total_score : 0 %>">
                                        <input type="hidden" name="elderly_risk_level" id="elderlyRiskLevelInput" value="<%= assessment ? assessment.elderly_risk_level : 'Low Risk' %>">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Educational Needs -->
                    <div class="form-section">
                        <h3><i class="fas fa-graduation-cap me-2" aria-hidden="true"></i>Educational Needs</h3>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="needs_medication_education" <%= assessment && assessment.needs_medication_education ? 'checked' : '' %> aria-label="Patient needs medication education">
                                    <label class="form-check-label">Medication Education</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="needs_diet_nutrition_education" <%= assessment && assessment.needs_diet_nutrition_education ? 'checked' : '' %> aria-label="Patient needs diet and nutrition education">
                                    <label class="form-check-label">Diet & Nutrition Education</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="needs_medical_equipment_education" <%= assessment && assessment.needs_medical_equipment_education ? 'checked' : '' %> aria-label="Patient needs medical equipment education">
                                    <label class="form-check-label">Medical Equipment Education</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="needs_rehabilitation_education" <%= assessment && assessment.needs_rehabilitation_education ? 'checked' : '' %> aria-label="Patient needs rehabilitation education">
                                    <label class="form-check-label">Rehabilitation Education</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="needs_drug_interaction_education" <%= assessment && assessment.needs_drug_interaction_education ? 'checked' : '' %> aria-label="Patient needs drug interaction education">
                                    <label class="form-check-label">Drug Interaction Education</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="needs_pain_symptom_education" <%= assessment && assessment.needs_pain_symptom_education ? 'checked' : '' %> aria-label="Patient needs pain symptom education">
                                    <label class="form-check-label">Pain Symptom Education</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="needs_fall_prevention_education" <%= assessment && assessment.needs_fall_prevention_education ? 'checked' : '' %> aria-label="Patient needs fall prevention education">
                                    <label class="form-check-label">Fall Prevention Education</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="other_needs" <%= assessment && assessment.other_needs ? 'checked' : '' %> aria-label="Patient has other educational needs">
                                    <label class="form-check-label">Other Needs</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Nurse Signature -->
                    <div class="form-section" id="signatureSection">
                        <h3><i class="fas fa-signature me-2" aria-hidden="true"></i>Nurse Signature</h3>
                        <div class="row g-3">
                            <div class="col-12">
                                <p class="text-muted mb-3">Click the button below to sign and submit this nursing assessment.</p>
                                <div id="signatureContainer">
                                    <div class="text-center">
                                        <button type="button" class="btn btn-success btn-lg" id="signFormButton">
                                            <i class="fas fa-signature me-2"></i>Sign the Form
                                        </button>
                                        <p class="text-muted mt-2">This will apply your signature and lock the form for editing</p>
                                    </div>
                                </div>
                                <div id="signedContainer" style="display: none;">
                                    <div class="alert alert-success text-center">
                                        <h4><i class="fas fa-check-circle me-2"></i>Form Signed Successfully!</h4>
                                        <p>Your signature has been applied to this assessment.</p>
                                        <img id="appliedSignature" src="" alt="Applied signature" class="border rounded mt-3" style="max-height: 80px; background: white;">
                                    </div>
                                </div>
                                <input type="hidden" name="nurse_signature" id="nurseSignatureInput">
                            </div>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="text-center mt-4">
                        <button type="submit" class="btn btn-primary btn-lg px-5" id="submitBtn" aria-label="Submit the completed nursing assessment" aria-describedby="submitStatus">
                            <i class="fas fa-save me-2" aria-hidden="true"></i>
                            <span id="submitBtnText">Submit Assessment</span>
                        </button>
                        <div id="submitStatus" class="sr-only" aria-live="polite">Ready to submit assessment</div>
                        <button type="submit" name="action" value="draft" class="btn btn-warning btn-lg px-4 me-3" id="draftBtn" aria-label="Save assessment as draft for later completion" aria-describedby="draftStatus">
                            <i class="fas fa-draft me-2" aria-hidden="true"></i>
                            <span id="draftBtnText">Save as Draft</span>
                        </button>
                        <div id="draftStatus" class="sr-only" aria-live="polite">Ready to save as draft</div>
                        <a href="/" class="btn btn-secondary btn-lg" aria-label="Return to home page without saving">
                            <i class="fas fa-arrow-left me-2" aria-hidden="true"></i>
                            Back to Home
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/form-validation.js"></script>

    <!-- Signature Script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check if assessment is completed
            const isCompleted = '<%= isCompleted %>' === 'true';
            const assessmentSignature = '<%= assessmentSignature %>';

            if (isCompleted) {
                // Disable all form inputs for completed assessments
                const form = document.getElementById('nurseForm');
                const inputs = form.querySelectorAll('input:not([type="hidden"]), select, textarea, button');
                inputs.forEach(input => {
                    input.disabled = true;
                    input.style.opacity = '0.6';
                });

                // Hide submit buttons and show completed message
                const submitBtn = document.getElementById('submitBtn');
                const draftBtn = document.getElementById('draftBtn');
                const backBtn = document.querySelector('a[href="/"]');

                if (submitBtn) submitBtn.style.display = 'none';
                if (draftBtn) draftBtn.style.display = 'none';

                // Update back button text
                if (backBtn) {
                    backBtn.innerHTML = '<i class="fas fa-arrow-left me-2"></i>Back to Dashboard';
                }

                // Show completed assessment message
                const signatureSection = document.getElementById('signatureSection');
                signatureSection.innerHTML = `
                    <h3><i class="fas fa-check-circle me-2" aria-hidden="true"></i>Assessment Completed</h3>
                    <div class="alert alert-success">
                        <h4><i class="fas fa-lock me-2"></i>This nursing assessment has been completed and signed.</h4>
                        <p>The assessment is locked for editing. To make changes, please contact an administrator.</p>
                        ${assessmentSignature ? `<img src="${assessmentSignature}" alt="Assessment signature" class="border rounded mt-3" style="max-height: 80px; background: white;">` : ''}
                        <p class="text-muted mt-2">Signed by the assessing nurse</p>
                    </div>
                `;

                // Add visual indicator to the page
                const mainContent = document.getElementById('main-content');
                const completedBanner = document.createElement('div');
                completedBanner.className = 'alert alert-info text-center mb-4';
                completedBanner.innerHTML = '<h4><i class="fas fa-info-circle me-2"></i>This assessment has been completed and is read-only</h4>';
                mainContent.insertBefore(completedBanner, mainContent.firstChild);

                return; // Exit early for completed assessments
            }
            // Auto-populate age from patient's date of birth
            const patientDOB = '<%= visit.date_of_birth %>';
            const ageField = document.getElementById('ageField');

            if (patientDOB && patientDOB !== 'null' && !ageField.value) {
                const birthDate = new Date(patientDOB);
                const today = new Date();
                let age = today.getFullYear() - birthDate.getFullYear();
                const monthDiff = today.getMonth() - birthDate.getMonth();

                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }

                ageField.value = age;
            }

            const signatureInput = document.getElementById('nurseSignatureInput');
            const signFormButton = document.getElementById('signFormButton');
            const signatureContainer = document.getElementById('signatureContainer');
            const signedContainer = document.getElementById('signedContainer');
            const appliedSignature = document.getElementById('appliedSignature');

            // Check if user has existing signature
            const userSignature = '<%= userSignature %>';
            const userRole = '<%= user.role %>';
            const isAdmin = userRole === 'admin';

            if (userSignature && userSignature !== 'null') {
                // User has signature, show sign button
                signatureContainer.style.display = 'block';
                signedContainer.style.display = 'none';

                // Handle sign form button
                signFormButton.addEventListener('click', function() {
                    // For signing, we just set the signature - form will be disabled after final submission
                    signatureInput.value = userSignature;
                    appliedSignature.src = userSignature;

                    // Show signed confirmation
                    signatureContainer.style.display = 'none';
                    signedContainer.style.display = 'block';

                    // Note: Form will be disabled only after final submission on the server side
                    // Draft saves don't disable the form
                });
            } else {
                // No signature - this shouldn't happen since signatures are required on user creation
                signatureContainer.innerHTML = '<div class="alert alert-warning">No signature found. Please contact an administrator to set up your signature.</div>';
            }

            function disableFormAfterSignature() {
                // Disable all form inputs except submit buttons
                const form = document.getElementById('nurseForm');
                const inputs = form.querySelectorAll('input:not([type="hidden"]):not([type="submit"]), select, textarea');
                inputs.forEach(input => {
                    input.disabled = true;
                    input.style.opacity = '0.6';
                });

                // Update signature section to show locked state
                const signatureSection = document.getElementById('signatureSection');
                signatureSection.innerHTML = `
                    <h3><i class="fas fa-lock me-2" aria-hidden="true"></i>Form Signed and Locked</h3>
                    <div class="alert alert-success">
                        <h4><i class="fas fa-check-circle me-2"></i>Assessment Signed Successfully!</h4>
                        <p>This nursing assessment has been signed and is now locked for editing.</p>
                        <img src="${userSignature}" alt="Applied signature" class="border rounded mt-3" style="max-height: 80px; background: white;">
                        <p class="text-muted mt-2">To make changes, please contact an administrator.</p>
                    </div>
                `;
            }

            // Form validation - check if signature exists before final submission only
            document.getElementById('nurseForm').addEventListener('submit', function(e) {
                // Check if this is a draft submission
                const submitButton = e.submitter;
                const isDraft = submitButton && submitButton.value === 'draft';

                // Only require signature for final submissions, not drafts
                if (!isDraft) {
                    const signatureData = signatureInput.value;
                    if (!signatureData || signatureData === '') {
                        e.preventDefault();
                        alert('Please sign the assessment before submitting.');
                        signFormButton.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        signFormButton.style.borderColor = '#dc3545';
                        setTimeout(() => {
                            signFormButton.style.borderColor = '';
                        }, 3000);
                        return false;
                    }
                }
            });

            // Morse Fall Scale calculation
            function calculateMorseScore() {
                let totalScore = 0;
                const morseRadios = document.querySelectorAll('.morse-radio:checked');

                morseRadios.forEach(radio => {
                    totalScore += parseInt(radio.getAttribute('data-score')) || 0;
                });

                // Update total score display
                document.getElementById('morseTotalScore').textContent = totalScore;
                document.getElementById('morseTotalScoreInput').value = totalScore;

                // Determine risk level
                let riskLevel = '';
                if (totalScore <= 10) {
                    riskLevel = 'Low Risk';
                } else if (totalScore <= 20) {
                    riskLevel = 'Medium Risk';
                } else if (totalScore <= 30) {
                    riskLevel = 'High Risk';
                } else {
                    riskLevel = 'Very High Risk';
                }

                document.getElementById('morseRiskLevel').textContent = riskLevel;
                document.getElementById('morseRiskLevelInput').value = riskLevel;

                // Update risk level color
                const riskElement = document.getElementById('morseRiskLevel');
                riskElement.className = 'text-warning'; // Reset class
                if (riskLevel === 'Low Risk') {
                    riskElement.className = 'text-success';
                } else if (riskLevel === 'Medium Risk') {
                    riskElement.className = 'text-warning';
                } else if (riskLevel === 'High Risk') {
                    riskElement.className = 'text-danger';
                } else {
                    riskElement.className = 'text-danger fw-bold';
                }
            }

            // Add event listeners to Morse scale radio buttons
            document.querySelectorAll('.morse-radio').forEach(radio => {
                radio.addEventListener('change', calculateMorseScore);
            });

            // Calculate initial Morse score on page load
            calculateMorseScore();

            // Pediatric Fall Risk calculation
            function calculatePediatricScore() {
                let totalScore = 0;
                const pediatricRadios = document.querySelectorAll('.pediatric-radio:checked');

                pediatricRadios.forEach(radio => {
                    totalScore += parseInt(radio.getAttribute('data-score')) || 0;
                });

                // Update total score display
                document.getElementById('pediatricTotalScore').textContent = totalScore;
                document.getElementById('pediatricTotalScoreInput').value = totalScore;

                // Determine risk level
                let riskLevel = '';
                if (totalScore <= 2) {
                    riskLevel = 'Low Risk';
                } else if (totalScore <= 4) {
                    riskLevel = 'Medium Risk';
                } else {
                    riskLevel = 'High Risk';
                }

                document.getElementById('pediatricRiskLevel').textContent = riskLevel;
                document.getElementById('pediatricRiskLevelInput').value = riskLevel;

                // Update risk level color
                const riskElement = document.getElementById('pediatricRiskLevel');
                riskElement.className = 'text-warning'; // Reset class
                if (riskLevel === 'Low Risk') {
                    riskElement.className = 'text-success';
                } else if (riskLevel === 'Medium Risk') {
                    riskElement.className = 'text-warning';
                } else {
                    riskElement.className = 'text-danger';
                }
            }

            // Add event listeners to Pediatric scale radio buttons
            document.querySelectorAll('.pediatric-radio').forEach(radio => {
                radio.addEventListener('change', calculatePediatricScore);
            });

            // Calculate initial Pediatric score on page load
            calculatePediatricScore();

            // Elderly Assessment calculation
            function calculateElderlyScore() {
                let totalScore = 0;

                // Radio buttons
                const elderlyRadios = document.querySelectorAll('.elderly-radio:checked');
                elderlyRadios.forEach(radio => {
                    totalScore += parseInt(radio.getAttribute('data-score')) || 0;
                });

                // Select dropdowns
                const elderlySelects = document.querySelectorAll('.elderly-select');
                elderlySelects.forEach(select => {
                    const selectedOption = select.options[select.selectedIndex];
                    totalScore += parseInt(selectedOption.getAttribute('data-score')) || 0;
                });

                // Checkboxes
                const elderlyCheckboxes = document.querySelectorAll('.elderly-checkbox:checked');
                elderlyCheckboxes.forEach(checkbox => {
                    totalScore += parseInt(checkbox.getAttribute('data-score')) || 0;
                });

                // Update total score display
                document.getElementById('elderlyTotalScore').textContent = totalScore;
                document.getElementById('elderlyTotalScoreInput').value = totalScore;

                // Determine risk level
                let riskLevel = '';
                if (totalScore <= 3) {
                    riskLevel = 'Low Risk';
                } else if (totalScore <= 6) {
                    riskLevel = 'Medium Risk';
                } else {
                    riskLevel = 'High Risk';
                }

                document.getElementById('elderlyRiskLevel').textContent = riskLevel;
                document.getElementById('elderlyRiskLevelInput').value = riskLevel;

                // Update risk level color
                const riskElement = document.getElementById('elderlyRiskLevel');
                riskElement.className = 'text-warning'; // Reset class
                if (riskLevel === 'Low Risk') {
                    riskElement.className = 'text-success';
                } else if (riskLevel === 'Medium Risk') {
                    riskElement.className = 'text-warning';
                } else {
                    riskElement.className = 'text-danger';
                }
            }

            // Add event listeners to Elderly assessment elements
            document.querySelectorAll('.elderly-radio, .elderly-select, .elderly-checkbox').forEach(element => {
                element.addEventListener('change', calculateElderlyScore);
            });

            // Calculate initial Elderly score on page load
            calculateElderlyScore();

            // Age-based assessment logic
            function toggleFallRiskAssessments() {
                const ageField = document.getElementById('ageField');
                const age = parseInt(ageField.value) || 0;

                const morseSection = document.getElementById('morseFallScaleSection');
                const pediatricSection = document.getElementById('pediatricFallRiskSection');
                const elderlySection = document.getElementById('elderlyAssessmentSection');

                if (age >= 65) {
                    // Show elderly assessment, hide others
                    morseSection.style.display = 'none';
                    pediatricSection.style.display = 'none';
                    elderlySection.style.display = 'block';
                } else if (age < 18 && age > 0) {
                    // Show pediatric assessment, hide others
                    morseSection.style.display = 'none';
                    pediatricSection.style.display = 'block';
                    elderlySection.style.display = 'none';
                } else {
                    // Show Morse assessment, hide others
                    morseSection.style.display = 'block';
                    pediatricSection.style.display = 'none';
                    elderlySection.style.display = 'none';
                }
            }

            // Add event listener to age field
            document.getElementById('ageField').addEventListener('input', toggleFallRiskAssessments);

            // Initial toggle based on current age
            toggleFallRiskAssessments();
        });
    </script>
</body>
</html>