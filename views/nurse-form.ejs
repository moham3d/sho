<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nursing Assessment Form - Al-Shorouk Radiology Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/css/custom.css" rel="stylesheet">
    <style>
        .form-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .form-section h3 {
            color: #495057;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .vital-signs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .vital-signs-grid > div {
            background: white;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #e9ecef;
        }
        .signature-pad {
            border: 2px dashed #dee2e6;
            border-radius: 5px;
        }
        canvas {
            display: block;
            margin: 0 auto;
        }
    </style>
</head>
<body class="bg-light">
    <!-- Navigation -->
    <%- include('navigation', { currentPage: 'assessment' }) %>

    <main class="container-fluid py-4" id="main-content">
        <div class="row justify-content-center">
            <div class="col-12 col-lg-10">
                <!-- Header -->
                <header class="text-center mb-4">
                    <h1 class="text-primary mb-2">
                        <i class="fas fa-user-nurse me-2" aria-hidden="true"></i>
                        Nursing Assessment Form
                    </h1>
                    <p class="text-muted">SH.MR.FRM.05 - Comprehensive Patient Screening</p>

                    <!-- Progress Indicator -->
                    <div class="progress mt-3" style="height: 25px;" role="progressbar" aria-label="Form completion progress" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
                        <div class="progress-bar bg-success" style="width: 0%" id="formProgress">
                            <span class="progress-text">0% Complete</span>
                        </div>
                    </div>
                    <small class="text-muted mt-1 d-block">
                        Form Completion Progress
                        <i class="fas fa-save text-success ms-2" title="Auto-save is enabled" aria-hidden="true"></i>
                        <small class="text-success">Auto-save active</small>
                    </small>

                    <!-- Status Announcements -->
                    <div id="formStatusAnnouncements" class="sr-only" aria-live="polite" aria-atomic="true">
                        Form progress: 0% complete. Auto-save is active.
                    </div>
                    <div id="autoSaveAnnouncements" class="sr-only" aria-live="assertive" aria-atomic="true">
                        <!-- Auto-save status announcements will appear here -->
                    </div>
                </header>

                <!-- Patient Information -->
                <div class="card mb-4 border-primary">
                    <div class="card-header bg-primary text-white">
                        <h3 class="mb-0">
                            <i class="fas fa-user me-2" aria-hidden="true"></i>Patient Information
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Full Name:</strong> <%= visit.full_name %></p>
                                <p><strong>SSN:</strong> <%= visit.patient_ssn %></p>
                                <p><strong>Medical Number:</strong> <%= visit.medical_number || 'Not provided' %></p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Mobile:</strong> <%= visit.mobile_number || 'Not provided' %></p>
                                <p><strong>Date of Birth:</strong> <%= visit.date_of_birth ? new Date(visit.date_of_birth).toLocaleDateString() : 'Not provided' %></p>
                                <p><strong>Gender:</strong> <%= visit.gender || 'Not provided' %></p>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-12">
                                <p><strong>Visit Date:</strong> <%= new Date(visit.visit_date || visit.created_at).toLocaleDateString() %></p>
                            </div>
                        </div>
                    </div>
                </div>

                <form id="nurseForm" action="/submit-nurse-form" method="POST">
                    <!-- Hidden fields -->
                    <input type="hidden" name="visit_id" value="<%= visit.visit_id %>">
                    <!-- Basic Assessment Info -->
                    <div class="form-section">
                        <h3><i class="fas fa-info-circle me-2" aria-hidden="true"></i>Basic Assessment Information</h3>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Mode of Arrival</label>
                                <select class="form-select" name="mode_of_arrival" required aria-label="Select patient's mode of arrival">
                                    <option value="">Select mode...</option>
                                    <option value="ambulatory" <%= assessment && assessment.mode_of_arrival === 'ambulatory' ? 'selected' : '' %>>Ambulatory</option>
                                    <option value="wheelchair" <%= assessment && assessment.mode_of_arrival === 'wheelchair' ? 'selected' : '' %>>Wheelchair</option>
                                    <option value="stretcher" <%= assessment && assessment.mode_of_arrival === 'stretcher' ? 'selected' : '' %>>Stretcher</option>
                                    <option value="other" <%= assessment && assessment.mode_of_arrival === 'other' ? 'selected' : '' %>>Other</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Age</label>
                                <input type="number" class="form-control" name="age" id="ageField" min="0" max="150" required value="<%= assessment ? assessment.age : '' %>" aria-label="Patient's age in years" aria-describedby="ageHelp">
                                <small class="text-muted" id="ageHelp">Auto-calculated from patient's date of birth</small>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Chief Complaint (الشكوي الحالية)</label>
                                <textarea class="form-control" name="chief_complaint" rows="3" required aria-label="Patient's chief complaint in Arabic and English"><%= assessment ? assessment.chief_complaint : '' %></textarea>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Accompanied By</label>
                                <select class="form-select" name="accompanied_by" aria-label="Person accompanying the patient">
                                    <option value="">Select...</option>
                                    <option value="spouse" <%= assessment && assessment.accompanied_by === 'spouse' ? 'selected' : '' %>>Spouse</option>
                                    <option value="relative" <%= assessment && assessment.accompanied_by === 'relative' ? 'selected' : '' %>>Relative</option>
                                    <option value="other" <%= assessment && assessment.accompanied_by === 'other' ? 'selected' : '' %>>Other</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Language Spoken</label>
                                <select class="form-select" name="language_spoken" aria-label="Primary language spoken by patient">
                                    <option value="arabic" <%= (!assessment || assessment.language_spoken === 'arabic') ? 'selected' : '' %>>Arabic</option>
                                    <option value="english" <%= assessment && assessment.language_spoken === 'english' ? 'selected' : '' %>>English</option>
                                    <option value="other" <%= assessment && assessment.language_spoken === 'other' ? 'selected' : '' %>>Other</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Vital Signs -->
                    <div class="form-section">
                        <h3><i class="fas fa-heartbeat me-2" aria-hidden="true"></i>Vital Signs</h3>
                        <div class="vital-signs-grid">
                            <div>
                                <label class="form-label">Temperature (°C)</label>
                                <input type="number" class="form-control" name="temperature_celsius" step="0.1" min="30" max="45" value="<%= assessment ? assessment.temperature_celsius : '' %>" aria-label="Body temperature in Celsius">
                            </div>
                            <div>
                                <label class="form-label">Pulse (BPM)</label>
                                <input type="number" class="form-control" name="pulse_bpm" min="30" max="200" value="<%= assessment ? assessment.pulse_bpm : '' %>" aria-label="Heart rate in beats per minute">
                            </div>
                            <div>
                                <label class="form-label">Blood Pressure (Systolic)</label>
                                <input type="number" class="form-control" name="blood_pressure_systolic" min="70" max="250" value="<%= assessment ? assessment.blood_pressure_systolic : '' %>" aria-label="Systolic blood pressure in mmHg">
                            </div>
                            <div>
                                <label class="form-label">Blood Pressure (Diastolic)</label>
                                <input type="number" class="form-control" name="blood_pressure_diastolic" min="40" max="150" value="<%= assessment ? assessment.blood_pressure_diastolic : '' %>" aria-label="Diastolic blood pressure in mmHg">
                            </div>
                            <div>
                                <label class="form-label">Respiratory Rate</label>
                                <input type="number" class="form-control" name="respiratory_rate_per_min" min="8" max="60" value="<%= assessment ? assessment.respiratory_rate_per_min : '' %>" aria-label="Respiratory rate in breaths per minute">
                            </div>
                            <div>
                                <label class="form-label">Oxygen Saturation (%)</label>
                                <input type="number" class="form-control" name="oxygen_saturation_percent" step="0.1" min="70" max="100" value="<%= assessment ? assessment.oxygen_saturation_percent : '' %>" aria-label="Blood oxygen saturation percentage">
                            </div>
                            <div>
                                <label class="form-label">Blood Sugar (mg/dL)</label>
                                <input type="number" class="form-control" name="blood_sugar_mg_dl" min="0" value="<%= assessment ? assessment.blood_sugar_mg_dl : '' %>" aria-label="Blood glucose level in mg/dL">
                            </div>
                            <div>
                                <label class="form-label">Weight (kg)</label>
                                <input type="number" class="form-control" name="weight_kg" step="0.1" min="0" max="500" value="<%= assessment ? assessment.weight_kg : '' %>" aria-label="Patient weight in kilograms">
                            </div>
                            <div>
                                <label class="form-label">Height (cm)</label>
                                <input type="number" class="form-control" name="height_cm" step="0.1" min="0" max="300" value="<%= assessment ? assessment.height_cm : '' %>" aria-label="Patient height in centimeters">
                            </div>
                        </div>
                    </div>

                    <!-- Psychosocial Assessment -->
                    <div class="form-section">
                        <h3><i class="fas fa-brain me-2" aria-hidden="true"></i>Psychosocial Assessment</h3>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Psychological Problem</label>
                                <select class="form-select" name="psychological_problem" aria-label="Patient's current psychological condition">
                                    <option value="none" <%= assessment && assessment.psychological_problem === 'none' ? 'selected' : '' %>>None</option>
                                    <option value="depressed" <%= assessment && assessment.psychological_problem === 'depressed' ? 'selected' : '' %>>Depressed</option>
                                    <option value="agitated" <%= assessment && assessment.psychological_problem === 'agitated' ? 'selected' : '' %>>Agitated</option>
                                    <option value="anxious" <%= assessment && assessment.psychological_problem === 'anxious' ? 'selected' : '' %>>Anxious</option>
                                    <option value="isolated" <%= assessment && assessment.psychological_problem === 'isolated' ? 'selected' : '' %>>Isolated</option>
                                    <option value="confused" <%= assessment && assessment.psychological_problem === 'confused' ? 'selected' : '' %>>Confused</option>
                                    <option value="other" <%= assessment && assessment.psychological_problem === 'other' ? 'selected' : '' %>>Other</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Smoker</label>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" name="is_smoker" <%= assessment && assessment.is_smoker ? 'checked' : '' %> aria-label="Patient is a smoker">
                                </div>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Allergies</label>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="has_allergies" id="has_allergies" <%= assessment && assessment.has_allergies ? 'checked' : '' %> aria-label="Patient has allergies">
                                            <label class="form-check-label" for="has_allergies">Has Allergies</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <input type="text" class="form-control" name="medication_allergies" placeholder="Medication allergies" value="<%= assessment ? assessment.medication_allergies : '' %>" aria-label="List of medication allergies">
                                    <input type="text" class="form-control mt-2" name="food_allergies" placeholder="Food allergies" value="<%= assessment ? assessment.food_allergies : '' %>" aria-label="List of food allergies">
                                    <input type="text" class="form-control mt-2" name="other_allergies" placeholder="Other allergies" value="<%= assessment ? assessment.other_allergies : '' %>" aria-label="List of other allergies">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Nutritional Screening -->
                    <div class="form-section">
                        <h3><i class="fas fa-utensils me-2" aria-hidden="true"></i>Nutritional Screening</h3>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Diet Type</label>
                                <select class="form-select" name="diet_type" aria-label="Patient's prescribed diet type">
                                    <option value="regular" <%= (!assessment || assessment.diet_type === 'regular') ? 'selected' : '' %>>Regular</option>
                                    <option value="special" <%= assessment && assessment.diet_type === 'special' ? 'selected' : '' %>>Special</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Appetite</label>
                                <select class="form-select" name="appetite" aria-label="Patient's current appetite level">
                                    <option value="good" <%= assessment && assessment.appetite === 'good' ? 'selected' : '' %>>Good</option>
                                    <option value="poor" <%= assessment && assessment.appetite === 'poor' ? 'selected' : '' %>>Poor</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Nutritional Issues</label>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="has_git_problems" <%= assessment && assessment.has_git_problems ? 'checked' : '' %> aria-label="Patient has gastrointestinal problems">
                                            <label class="form-check-label">GI Problems</label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="has_weight_loss" <%= assessment && assessment.has_weight_loss ? 'checked' : '' %> aria-label="Patient has experienced weight loss">
                                            <label class="form-check-label">Weight Loss</label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="has_weight_gain" <%= assessment && assessment.has_weight_gain ? 'checked' : '' %> aria-label="Patient has experienced weight gain">
                                            <label class="form-check-label">Weight Gain</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Functional Assessment -->
                    <div class="form-section">
                        <h3><i class="fas fa-wheelchair me-2" aria-hidden="true"></i>Functional Assessment</h3>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Feeding Status</label>
                                <select class="form-select" name="feeding_status" aria-label="Patient's feeding independence level">
                                    <option value="independent" <%= assessment && assessment.feeding_status === 'independent' ? 'selected' : '' %>>Independent</option>
                                    <option value="needs_supervision" <%= assessment && assessment.feeding_status === 'needs_supervision' ? 'selected' : '' %>>Needs Supervision</option>
                                    <option value="totally_dependent" <%= assessment && assessment.feeding_status === 'totally_dependent' ? 'selected' : '' %>>Totally Dependent</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Hygiene Status</label>
                                <select class="form-select" name="hygiene_status" aria-label="Patient's hygiene independence level">
                                    <option value="independent" <%= assessment && assessment.hygiene_status === 'independent' ? 'selected' : '' %>>Independent</option>
                                    <option value="needs_supervision" <%= assessment && assessment.hygiene_status === 'needs_supervision' ? 'selected' : '' %>>Needs Supervision</option>
                                    <option value="totally_dependent" <%= assessment && assessment.hygiene_status === 'totally_dependent' ? 'selected' : '' %>>Totally Dependent</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Toileting Status</label>
                                <select class="form-select" name="toileting_status" aria-label="Patient's toileting independence level">
                                    <option value="independent" <%= assessment && assessment.toileting_status === 'independent' ? 'selected' : '' %>>Independent</option>
                                    <option value="needs_supervision" <%= assessment && assessment.toileting_status === 'needs_supervision' ? 'selected' : '' %>>Needs Supervision</option>
                                    <option value="totally_dependent" <%= assessment && assessment.toileting_status === 'totally_dependent' ? 'selected' : '' %>>Totally Dependent</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Ambulation Status</label>
                                <select class="form-select" name="ambulation_status" aria-label="Patient's walking independence level">
                                    <option value="independent" <%= assessment && assessment.ambulation_status === 'independent' ? 'selected' : '' %>>Independent</option>
                                    <option value="needs_supervision" <%= assessment && assessment.ambulation_status === 'needs_supervision' ? 'selected' : '' %>>Needs Supervision</option>
                                    <option value="totally_dependent" <%= assessment && assessment.ambulation_status === 'totally_dependent' ? 'selected' : '' %>>Totally Dependent</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Assistive Equipment</label>
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="uses_walker" <%= assessment && assessment.uses_walker ? 'checked' : '' %> aria-label="Patient uses a walker">
                                            <label class="form-check-label">Walker</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="uses_wheelchair" <%= assessment && assessment.uses_wheelchair ? 'checked' : '' %> aria-label="Patient uses a wheelchair">
                                            <label class="form-check-label">Wheelchair</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="uses_transfer_device" <%= assessment && assessment.uses_transfer_device ? 'checked' : '' %> aria-label="Patient uses a transfer device">
                                            <label class="form-check-label">Transfer Device</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="uses_other_equipment" <%= assessment && assessment.uses_other_equipment ? 'checked' : '' %> aria-label="Patient uses other assistive equipment">
                                            <label class="form-check-label">Other</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pain Assessment -->
                    <div class="form-section">
                        <h3><i class="fas fa-exclamation-triangle me-2" aria-hidden="true"></i>Pain Assessment</h3>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Pain Intensity (0-10)</label>
                                <input type="range" class="form-range" name="pain_intensity" min="0" max="10" value="<%= assessment ? assessment.pain_intensity : 0 %>" oninput="this.nextElementSibling.value = this.value" aria-label="Pain intensity level" aria-valuemin="0" aria-valuemax="10" aria-valuenow="<%= assessment ? assessment.pain_intensity : 0 %>">
                                <output><%= assessment ? assessment.pain_intensity : 0 %></output>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Pain Location</label>
                                <input type="text" class="form-control" name="pain_location" value="<%= assessment ? assessment.pain_location : '' %>" aria-label="Location of patient's pain">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Pain Frequency</label>
                                <input type="text" class="form-control" name="pain_frequency" value="<%= assessment ? assessment.pain_frequency : '' %>" aria-label="Frequency of patient's pain">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Pain Character</label>
                                <input type="text" class="form-control" name="pain_character" value="<%= assessment ? assessment.pain_character : '' %>" aria-label="Description of patient's pain character">
                            </div>
                        </div>
                    </div>

                    <!-- Educational Needs -->
                    <div class="form-section">
                        <h3><i class="fas fa-graduation-cap me-2" aria-hidden="true"></i>Educational Needs</h3>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="needs_medication_education" <%= assessment && assessment.needs_medication_education ? 'checked' : '' %> aria-label="Patient needs medication education">
                                    <label class="form-check-label">Medication Education</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="needs_diet_nutrition_education" <%= assessment && assessment.needs_diet_nutrition_education ? 'checked' : '' %> aria-label="Patient needs diet and nutrition education">
                                    <label class="form-check-label">Diet & Nutrition Education</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="needs_medical_equipment_education" <%= assessment && assessment.needs_medical_equipment_education ? 'checked' : '' %> aria-label="Patient needs medical equipment education">
                                    <label class="form-check-label">Medical Equipment Education</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="needs_rehabilitation_education" <%= assessment && assessment.needs_rehabilitation_education ? 'checked' : '' %> aria-label="Patient needs rehabilitation education">
                                    <label class="form-check-label">Rehabilitation Education</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="needs_drug_interaction_education" <%= assessment && assessment.needs_drug_interaction_education ? 'checked' : '' %> aria-label="Patient needs drug interaction education">
                                    <label class="form-check-label">Drug Interaction Education</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="needs_pain_symptom_education" <%= assessment && assessment.needs_pain_symptom_education ? 'checked' : '' %> aria-label="Patient needs pain symptom education">
                                    <label class="form-check-label">Pain Symptom Education</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="needs_fall_prevention_education" <%= assessment && assessment.needs_fall_prevention_education ? 'checked' : '' %> aria-label="Patient needs fall prevention education">
                                    <label class="form-check-label">Fall Prevention Education</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="other_needs" <%= assessment && assessment.other_needs ? 'checked' : '' %> aria-label="Patient has other educational needs">
                                    <label class="form-check-label">Other Needs</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Nurse Signature -->
                    <div class="form-section" id="signatureSection">
                        <h3><i class="fas fa-signature me-2" aria-hidden="true"></i>Nurse Signature</h3>
                        <div class="row g-3">
                            <div class="col-12">
                                <p class="text-muted mb-3">Click the button below to sign and submit this nursing assessment.</p>
                                <div id="signatureContainer">
                                    <div class="text-center">
                                        <button type="button" class="btn btn-success btn-lg" id="signFormButton">
                                            <i class="fas fa-signature me-2"></i>Sign the Form
                                        </button>
                                        <p class="text-muted mt-2">This will apply your signature and lock the form for editing</p>
                                    </div>
                                </div>
                                <div id="signedContainer" style="display: none;">
                                    <div class="alert alert-success text-center">
                                        <h4><i class="fas fa-check-circle me-2"></i>Form Signed Successfully!</h4>
                                        <p>Your signature has been applied to this assessment.</p>
                                        <img id="appliedSignature" src="" alt="Applied signature" class="border rounded mt-3" style="max-height: 80px; background: white;">
                                    </div>
                                </div>
                                <input type="hidden" name="nurse_signature" id="nurseSignatureInput">
                            </div>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="text-center mt-4">
                        <button type="submit" class="btn btn-primary btn-lg px-5" id="submitBtn" aria-label="Submit the completed nursing assessment" aria-describedby="submitStatus">
                            <i class="fas fa-save me-2" aria-hidden="true"></i>
                            <span id="submitBtnText">Submit Assessment</span>
                        </button>
                        <div id="submitStatus" class="sr-only" aria-live="polite">Ready to submit assessment</div>
                        <button type="submit" name="action" value="draft" class="btn btn-warning btn-lg px-4 me-3" id="draftBtn" aria-label="Save assessment as draft for later completion" aria-describedby="draftStatus">
                            <i class="fas fa-draft me-2" aria-hidden="true"></i>
                            <span id="draftBtnText">Save as Draft</span>
                        </button>
                        <div id="draftStatus" class="sr-only" aria-live="polite">Ready to save as draft</div>
                        <a href="/" class="btn btn-secondary btn-lg" aria-label="Return to home page without saving">
                            <i class="fas fa-arrow-left me-2" aria-hidden="true"></i>
                            Back to Home
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/form-validation.js"></script>

    <!-- Signature Script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Auto-populate age from patient's date of birth
            const patientDOB = '<%= visit.date_of_birth %>';
            const ageField = document.getElementById('ageField');

            if (patientDOB && patientDOB !== 'null' && !ageField.value) {
                const birthDate = new Date(patientDOB);
                const today = new Date();
                let age = today.getFullYear() - birthDate.getFullYear();
                const monthDiff = today.getMonth() - birthDate.getMonth();

                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }

                ageField.value = age;
            }

            const signatureInput = document.getElementById('nurseSignatureInput');
            const signFormButton = document.getElementById('signFormButton');
            const signatureContainer = document.getElementById('signatureContainer');
            const signedContainer = document.getElementById('signedContainer');
            const appliedSignature = document.getElementById('appliedSignature');

            // Check if user has existing signature
            const userSignature = '<%= userSignature %>';
            const userRole = '<%= user.role %>';
            const isAdmin = userRole === 'admin';

            if (userSignature && userSignature !== 'null') {
                // User has signature, show sign button
                signatureContainer.style.display = 'block';
                signedContainer.style.display = 'none';

                // Handle sign form button
                signFormButton.addEventListener('click', function() {
                    // Show confirmation dialog
                    const confirmed = confirm('⚠️ WARNING: Signing this assessment will mark it as completed and lock it for editing.\n\nOnce signed, you will not be able to make any further changes to this assessment.\n\nAre you sure you want to sign and complete this assessment?');

                    if (!confirmed) {
                        return; // User cancelled
                    }

                    signatureInput.value = userSignature;
                    appliedSignature.src = userSignature;

                    // Show signed confirmation
                    signatureContainer.style.display = 'none';
                    signedContainer.style.display = 'block';

                    // Disable form (unless admin)
                    if (!isAdmin) {
                        disableFormAfterSignature();
                    }
                });
            } else {
                // No signature - this shouldn't happen since signatures are required on user creation
                signatureContainer.innerHTML = '<div class="alert alert-warning">No signature found. Please contact an administrator to set up your signature.</div>';
            }

            function disableFormAfterSignature() {
                // Disable all form inputs except submit buttons
                const form = document.getElementById('nurseForm');
                const inputs = form.querySelectorAll('input:not([type="hidden"]):not([type="submit"]), select, textarea');
                inputs.forEach(input => {
                    input.disabled = true;
                    input.style.opacity = '0.6';
                });

                // Update signature section to show locked state
                const signatureSection = document.getElementById('signatureSection');
                signatureSection.innerHTML = `
                    <h3><i class="fas fa-lock me-2" aria-hidden="true"></i>Form Signed and Locked</h3>
                    <div class="alert alert-success">
                        <h4><i class="fas fa-check-circle me-2"></i>Assessment Signed Successfully!</h4>
                        <p>This nursing assessment has been signed and is now locked for editing.</p>
                        <img src="${userSignature}" alt="Applied signature" class="border rounded mt-3" style="max-height: 80px; background: white;">
                        <p class="text-muted mt-2">To make changes, please contact an administrator.</p>
                    </div>
                `;
            }

            // Form validation - check if signature exists before submission
            document.getElementById('nurseForm').addEventListener('submit', function(e) {
                const signatureData = signatureInput.value;
                if (!signatureData || signatureData === '') {
                    e.preventDefault();
                    alert('Please sign the assessment before submitting.');
                    signFormButton.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    signFormButton.style.borderColor = '#dc3545';
                    setTimeout(() => {
                        signFormButton.style.borderColor = '';
                    }, 3000);
                    return false;
                }
            });
        });
    </script>
</body>
</html>