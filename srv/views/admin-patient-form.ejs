<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= patient ? 'Edit' : 'Add' %> Patient - Al-Shorouk Radiology Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/css/custom.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .navbar-brand {
            font-weight: bold;
        }
        .navbar-brand i {
            color: #ffffff;
        }
        .navbar-nav .nav-link {
            font-weight: 500;
            transition: color 0.3s ease;
        }
        .navbar-nav .nav-link:hover {
            color: rgba(255, 255, 255, 0.8) !important;
        }
        .navbar-nav .nav-link.active {
            color: #ffffff !important;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }
        .user-info {
            font-size: 0.9em;
            color: rgba(255, 255, 255, 0.9);
        }
        .user-role {
            font-weight: 600;
            text-transform: capitalize;
        }
        .logout-btn {
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }
        .logout-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.5);
        }
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .form-label {
            font-weight: 600;
            color: #495057;
        }
        .form-control, .form-select {
            border-radius: 8px;
            border: 2px solid #e9ecef;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .form-control:focus, .form-select:focus {
            border-color: #28a745;
            box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
        }
        .btn-custom {
            border-radius: 25px;
            padding: 10px 30px;
            font-weight: 600;
        }
        .required-field::after {
            content: " *";
            color: #dc3545;
        }
        .form-section {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .section-title {
            color: #28a745;
            font-weight: 600;
            margin-bottom: 15px;
        }
        .invalid-feedback {
            display: block;
        }
        .input-group-text {
            background-color: #28a745;
            color: white;
            border: none;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <%- include('navigation', { currentPage: 'admin' }) %>

    <div class="container mt-4" id="main-content" role="main">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <!-- Breadcrumbs -->
                <nav aria-label="breadcrumb" class="mb-3">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a href="/"><i class="fas fa-home me-1" aria-hidden="true"></i>Home</a>
                        </li>
                        <li class="breadcrumb-item">
                            <a href="/admin">Admin</a>
                        </li>
                        <li class="breadcrumb-item">
                            <a href="/admin/patients">Patient Management</a>
                        </li>
                        <li class="breadcrumb-item active" aria-current="page">
                            <%= patient ? 'Edit Patient' : 'Add New Patient' %>
                        </li>
                    </ol>
                </nav>

                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2>
                            <i class="fas fa-<%= patient ? 'edit' : 'plus' %> me-2" aria-hidden="true"></i>
                            <%= patient ? 'Edit Patient' : 'Add New Patient' %>
                        </h2>
                        <p class="text-muted">
                            <%= patient ? 'Update patient information' : 'Create a new patient record' %>
                        </p>
                    </div>
                    <a href="/admin/patients" class="btn btn-outline-secondary btn-custom">
                        <i class="fas fa-arrow-left me-2" aria-hidden="true"></i>Back to Patients
                    </a>
                </div>
            </div>
        </div>

        <!-- Notification -->
        <% if (notification) { %>
            <div class="alert alert-<%= notification.type === 'success' ? 'success' : 'danger' %> alert-dismissible fade show" role="alert">
                <i class="fas fa-<%= notification.type === 'success' ? 'check-circle' : 'exclamation-triangle' %> me-2" aria-hidden="true"></i>
                <%= notification.message %>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        <% } %>

        <!-- Patient Form -->
        <div class="row">
            <div class="col-12">
                <form method="POST" action="<%= patient ? `/admin/patients/${patient.ssn}` : '/admin/patients' %>" id="patientForm" novalidate>
                    <!-- Personal Information Section -->
                    <div class="card form-section">
                        <h4 class="section-title">
                            <i class="fas fa-user me-2" aria-hidden="true"></i>Personal Information
                        </h4>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="ssn" class="form-label required-field">Social Security Number (SSN)</label>
                                <input type="text" class="form-control" id="ssn" name="ssn"
                                       value="<%= patient ? patient.ssn : '' %>"
                                       <%= patient ? 'readonly' : '' %>
                                       pattern="[0-9]{14}" maxlength="14" required>
                                <div class="invalid-feedback">
                                    Please enter a valid 14-digit SSN.
                                </div>
                                <% if (!patient) { %>
                                    <div class="form-text">
                                        <i class="fas fa-info-circle me-1" aria-hidden="true"></i>
                                        Must be exactly 14 digits (e.g., 12345678901234)
                                    </div>
                                <% } %>
                            </div>
                            <div class="col-md-6">
                                <label for="full_name" class="form-label required-field">Full Name</label>
                                <input type="text" class="form-control" id="full_name" name="full_name"
                                       value="<%= patient ? patient.full_name : '' %>" required>
                                <div class="invalid-feedback">
                                    Please enter the patient's full name.
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="date_of_birth" class="form-label">Date of Birth</label>
                                <input type="date" class="form-control" id="date_of_birth" name="date_of_birth"
                                       value="<%= patient && patient.date_of_birth ? new Date(patient.date_of_birth).toISOString().split('T')[0] : '' %>">
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1" aria-hidden="true"></i>
                                    Leave empty if date of birth is not available
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="gender" class="form-label required-field">Gender</label>
                                <select class="form-select" id="gender" name="gender" required>
                                    <option value="">Select Gender</option>
                                    <option value="male" <%= patient && patient.gender === 'male' ? 'selected' : '' %>>Male</option>
                                    <option value="female" <%= patient && patient.gender === 'female' ? 'selected' : '' %>>Female</option>
                                    <option value="other" <%= patient && patient.gender === 'other' ? 'selected' : '' %>>Other</option>
                                </select>
                                <div class="invalid-feedback">
                                    Please select the patient's gender.
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Contact Information Section -->
                    <div class="card form-section">
                        <h4 class="section-title">
                            <i class="fas fa-address-book me-2" aria-hidden="true"></i>Contact Information
                        </h4>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="mobile_number" class="form-label required-field">Mobile Number</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-mobile-alt" aria-hidden="true"></i></span>
                                    <input type="tel" class="form-control" id="mobile_number" name="mobile_number"
                                           value="<%= patient ? patient.mobile_number : '' %>"
                                           pattern="^(\+20|0)?1[0-2,5]\d{8}$" required>
                                </div>
                                <div class="invalid-feedback">
                                    Please enter a valid Egyptian mobile number (e.g., +201234567890 or 01234567890).
                                </div>
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1" aria-hidden="true"></i>
                                    Format: +20XXXXXXXXXX or 0XXXXXXXXXX
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="email" class="form-label">Email Address</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-envelope" aria-hidden="true"></i></span>
                                    <input type="email" class="form-control" id="email" name="email"
                                           value="<%= patient ? patient.email : '' %>">
                                </div>
                                <div class="invalid-feedback">
                                    Please enter a valid email address.
                                </div>
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1" aria-hidden="true"></i>
                                    Optional field - leave empty if not available
                                </div>
                            </div>
                            <div class="col-12">
                                <label for="address" class="form-label">Address</label>
                                <textarea class="form-control" id="address" name="address" rows="3"
                                          placeholder="Enter patient's full address"><%= patient ? patient.address : '' %></textarea>
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1" aria-hidden="true"></i>
                                    Optional field - leave empty if not available
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Medical Information Section -->
                    <div class="card form-section">
                        <h4 class="section-title">
                            <i class="fas fa-notes-medical me-2" aria-hidden="true"></i>Medical Information
                        </h4>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="medical_number" class="form-label">Medical Number</label>
                                <input type="text" class="form-control" id="medical_number" name="medical_number"
                                       value="<%= patient ? patient.medical_number : '' %>"
                                       placeholder="Enter medical record number">
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1" aria-hidden="true"></i>
                                    Optional field - hospital or clinic medical record number
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="emergency_contact" class="form-label">Emergency Contact</label>
                                <input type="text" class="form-control" id="emergency_contact" name="emergency_contact"
                                       value="<%= patient ? patient.emergency_contact : '' %>"
                                       placeholder="Emergency contact name and number">
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1" aria-hidden="true"></i>
                                    Optional field - emergency contact information
                                </div>
                            </div>
                            <div class="col-12">
                                <label for="medical_history" class="form-label">Medical History</label>
                                <textarea class="form-control" id="medical_history" name="medical_history" rows="4"
                                          placeholder="Enter any relevant medical history, allergies, or chronic conditions"><%= patient ? patient.medical_history : '' %></textarea>
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1" aria-hidden="true"></i>
                                    Optional field - include allergies, chronic conditions, previous surgeries, etc.
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="text-muted">
                                    <i class="fas fa-info-circle me-1" aria-hidden="true"></i>
                                    Fields marked with <span class="text-danger">*</span> are required
                                </div>
                                <div class="d-flex gap-2">
                                    <a href="/admin/patients" class="btn btn-outline-secondary btn-custom">
                                        <i class="fas fa-times me-2" aria-hidden="true"></i>Cancel
                                    </a>
                                    <button type="submit" class="btn btn-success btn-custom">
                                        <i class="fas fa-save me-2" aria-hidden="true"></i>
                                        <%= patient ? 'Update Patient' : 'Create Patient' %>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Form validation
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('patientForm');

            form.addEventListener('submit', function(event) {
                if (!form.checkValidity()) {
                    event.preventDefault();
                    event.stopPropagation();

                    // Find first invalid field and focus it
                    const firstInvalid = form.querySelector(':invalid');
                    if (firstInvalid) {
                        firstInvalid.focus();
                        firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
                form.classList.add('was-validated');
            });

            // Real-time SSN validation
            const ssnInput = document.getElementById('ssn');
            if (ssnInput) {
                ssnInput.addEventListener('input', function() {
                    const value = this.value.replace(/\D/g, ''); // Remove non-digits
                    this.value = value;

                    if (value.length === 14) {
                        this.setCustomValidity('');
                    } else {
                        this.setCustomValidity('SSN must be exactly 14 digits');
                    }
                });
            }

            // Real-time mobile number validation
            const mobileInput = document.getElementById('mobile_number');
            if (mobileInput) {
                mobileInput.addEventListener('input', function() {
                    const value = this.value.replace(/\D/g, ''); // Remove non-digits

                    // Format as Egyptian mobile number
                    if (value.startsWith('20') && value.length <= 12) {
                        this.value = '+' + value;
                    } else if (value.startsWith('0') && value.length <= 11) {
                        this.value = value;
                    } else if (value.length <= 10) {
                        this.value = '0' + value;
                    } else {
                        this.value = value.substring(0, 11);
                    }

                    // Validate format
                    const egyptianMobileRegex = /^(\+20|0)?1[0-2,5]\d{8}$/;
                    if (egyptianMobileRegex.test(this.value)) {
                        this.setCustomValidity('');
                    } else {
                        this.setCustomValidity('Please enter a valid Egyptian mobile number');
                    }
                });
            }

            // Date of birth validation
            const dobInput = document.getElementById('date_of_birth');
            if (dobInput) {
                dobInput.addEventListener('change', function() {
                    const selectedDate = new Date(this.value);
                    const today = new Date();

                    if (selectedDate > today) {
                        this.setCustomValidity('Date of birth cannot be in the future');
                        this.classList.add('is-invalid');
                    } else {
                        this.setCustomValidity('');
                        this.classList.remove('is-invalid');
                    }
                });
            }

            // Email validation enhancement
            const emailInput = document.getElementById('email');
            if (emailInput) {
                emailInput.addEventListener('blur', function() {
                    if (this.value && !this.checkValidity()) {
                        this.classList.add('is-invalid');
                    } else {
                        this.classList.remove('is-invalid');
                    }
                });
            }
        });
    </script>
</body>
</html>