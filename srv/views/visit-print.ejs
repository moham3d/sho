<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visit Report - <%= visit.visit_id %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @media print {
            body {
                font-size: 12px;
                line-height: 1.4;
            }
            .no-print {
                display: none !important;
            }
            .page-break {
                page-break-before: always;
            }
            .card {
                border: 1px solid #dee2e6 !important;
                box-shadow: none !important;
            }
        }

        body {
            font-size: 14px;
            line-height: 1.5;
            background-color: white;
        }

        .header-section {
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
        }

        .report-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .report-subtitle {
            font-size: 16px;
            opacity: 0.9;
        }

        .section-title {
            background-color: #f8f9fa;
            padding: 10px 15px;
            margin: 20px 0 10px 0;
            border-left: 4px solid #007bff;
            font-weight: bold;
            font-size: 16px;
        }

        .info-grid {
            display: table;
            width: 100%;
            margin-bottom: 15px;
        }

        .info-row {
            display: table-row;
        }

        .info-cell {
            display: table-cell;
            padding: 8px 12px;
            border-bottom: 1px solid #dee2e6;
        }

        .info-label {
            font-weight: bold;
            background-color: #f8f9fa;
            width: 200px;
        }

        .vital-signs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .vital-sign-card {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            border: 1px solid #dee2e6;
        }

        .vital-sign-value {
            font-size: 18px;
            font-weight: bold;
            color: #007bff;
        }

        .vital-sign-label {
            font-size: 12px;
            color: #495057;
            margin-top: 5px;
        }

        .assessment-content {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #28a745;
        }

        .print-button {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .footer-section {
            margin-top: 50px;
            padding-top: 20px;
            border-top: 2px solid #dee2e6;
            text-align: center;
            font-size: 12px;
            color: #495057;
        }
    </style>
</head>
<body>
    <!-- Print Button (hidden in print) -->
    <div class="no-print print-button">
        <button onclick="window.print()" class="btn btn-primary">
            <i class="fas fa-print me-2"></i>Print Report
        </button>
        <button onclick="window.close()" class="btn btn-secondary ms-2">
            <i class="fas fa-times me-2"></i>Close
        </button>
    </div>

    <!-- Header Section -->
    <div class="header-section">
        <div class="report-title">
            <i class="fas fa-hospital me-2"></i>Al-Shorouk Radiology Management System
        </div>
        <div class="report-subtitle">
            Patient Visit Report
        </div>
        <div style="margin-top: 15px; font-size: 14px;">
            Visit ID: <%= visit.visit_id %> | Generated: <%= new Date().toLocaleString() %>
        </div>
    </div>

    <div class="container-fluid">
        <!-- Visit Information -->
        <div class="section-title">
            <i class="fas fa-calendar-check me-2"></i>Visit Information
        </div>

        <div class="info-grid">
            <div class="info-row">
                <div class="info-cell info-label">Visit Date:</div>
                <div class="info-cell"><%= new Date(visit.visit_date).toLocaleDateString() %> <%= new Date(visit.visit_date).toLocaleTimeString() %></div>
                <div class="info-cell info-label">Visit Status:</div>
                <div class="info-cell">
                    <% if (visit.visit_status === 'completed') { %>
                        <span style="color: #28a745; font-weight: bold;"><i class="fas fa-check-circle me-1"></i>Completed</span>
                    <% } else if (visit.visit_status === 'in_progress') { %>
                        <span style="color: #ffc107; font-weight: bold;"><i class="fas fa-clock me-1"></i>In Progress</span>
                    <% } else if (visit.visit_status === 'open') { %>
                        <span style="color: #17a2b8; font-weight: bold;"><i class="fas fa-circle me-1"></i>Open</span>
                    <% } else { %>
                        <%= visit.visit_status %>
                    <% } %>
                </div>
            </div>
            <div class="info-row">
                <div class="info-cell info-label">Department:</div>
                <div class="info-cell"><%= visit.department || 'Not specified' %></div>
                <div class="info-cell info-label">Visit Type:</div>
                <div class="info-cell"><%= visit.visit_type || 'Not specified' %></div>
            </div>
            <% if (visit.completed_at) { %>
                <div class="info-row">
                    <div class="info-cell info-label">Completed At:</div>
                    <div class="info-cell"><%= new Date(visit.completed_at).toLocaleDateString() %> <%= new Date(visit.completed_at).toLocaleTimeString() %></div>
                    <div class="info-cell info-label"></div>
                    <div class="info-cell"></div>
                </div>
            <% } %>
        </div>

        <!-- Patient Information -->
        <div class="section-title">
            <i class="fas fa-user me-2"></i>Patient Information
        </div>

        <div class="info-grid">
            <div class="info-row">
                <div class="info-cell info-label">Full Name:</div>
                <div class="info-cell"><%= visit.full_name %></div>
                <div class="info-cell info-label">Medical Number:</div>
                <div class="info-cell"><%= visit.medical_number %></div>
            </div>
            <div class="info-row">
                <div class="info-cell info-label">SSN:</div>
                <div class="info-cell"><%= visit.patient_ssn %></div>
                <div class="info-cell info-label">Date of Birth:</div>
                <div class="info-cell"><%= new Date(visit.date_of_birth).toLocaleDateString() %></div>
            </div>
            <div class="info-row">
                <div class="info-cell info-label">Gender:</div>
                <div class="info-cell"><%= visit.gender %></div>
                <div class="info-cell info-label">Age:</div>
                <div class="info-cell"><%= Math.floor((new Date() - new Date(visit.date_of_birth)) / (365.25 * 24 * 60 * 60 * 1000)) %> years</div>
            </div>
            <div class="info-row">
                <div class="info-cell info-label">Mobile Number:</div>
                <div class="info-cell"><%= visit.mobile_number %></div>
                <div class="info-cell info-label">Phone Number:</div>
                <div class="info-cell"><%= visit.phone_number %></div>
            </div>
            <div class="info-row">
                <div class="info-cell info-label">Address:</div>
                <div class="info-cell" colspan="3"><%= visit.address %></div>
            </div>
            <div class="info-row">
                <div class="info-cell info-label">Emergency Contact:</div>
                <div class="info-cell"><%= visit.emergency_contact_name %> (<%= visit.emergency_contact_relation %>)</div>
                <div class="info-cell info-label">Emergency Phone:</div>
                <div class="info-cell"><%= visit.emergency_contact_phone %></div>
            </div>
        </div>

        <!-- Diagnosis Information -->
        <% if (visit.primary_diagnosis) { %>
            <div class="section-title">
                <i class="fas fa-stethoscope me-2"></i>Diagnosis Information
            </div>

            <div class="info-grid">
                <div class="info-row">
                    <div class="info-cell info-label">Primary Diagnosis:</div>
                    <div class="info-cell"><%= visit.primary_diagnosis %></div>
                    <div class="info-cell info-label">Diagnosis Code:</div>
                    <div class="info-cell"><%= visit.diagnosis_code || 'N/A' %></div>
                </div>
                <% if (visit.secondary_diagnosis) { %>
                    <div class="info-row">
                        <div class="info-cell info-label">Secondary Diagnosis:</div>
                        <div class="info-cell"><%= visit.secondary_diagnosis %></div>
                        <div class="info-cell info-label"></div>
                        <div class="info-cell"></div>
                    </div>
                <% } %>
                <% if (visit.notes) { %>
                    <div class="info-row">
                        <div class="info-cell info-label">Notes:</div>
                        <div class="info-cell" colspan="3"><%= visit.notes %></div>
                    </div>
                <% } %>
            </div>
        <% } %>

        <!-- Nursing Assessment -->
        <% if (nursingAssessment) { %>
            <div class="section-title page-break">
                <i class="fas fa-user-nurse me-2"></i>Nursing Assessment
            </div>

            <div class="info-grid">
                <div class="info-row">
                    <div class="info-cell info-label">Assessed By:</div>
                    <div class="info-cell"><%= nursingAssessment.assessed_by_name || 'Unknown' %></div>
                    <div class="info-cell info-label">Assessment Date:</div>
                    <div class="info-cell"><%= nursingAssessment.assessed_at ? new Date(nursingAssessment.assessed_at).toLocaleString() : 'Not specified' %></div>
                </div>
            </div>

            <% if (nursingAssessment.chief_complaint) { %>
                <div class="info-grid">
                    <div class="info-row">
                        <div class="info-cell info-label">Chief Complaint:</div>
                        <div class="info-cell" colspan="3"><%= nursingAssessment.chief_complaint %></div>
                    </div>
                </div>
            <% } %>

            <!-- Vital Signs -->
            <div style="margin: 20px 0;">
                <strong>Vital Signs:</strong>
                <div class="vital-signs-grid">
                    <div class="vital-sign-card">
                        <div class="vital-sign-value"><%= nursingAssessment.temperature_celsius || 'N/A' %></div>
                        <div class="vital-sign-label">Temperature (°C)</div>
                    </div>
                    <div class="vital-sign-card">
                        <div class="vital-sign-value"><%= nursingAssessment.pulse_bpm || 'N/A' %></div>
                        <div class="vital-sign-label">Pulse (bpm)</div>
                    </div>
                    <div class="vital-sign-card">
                        <div class="vital-sign-value"><%= nursingAssessment.blood_pressure_systolic || 'N/A' %>/<%= nursingAssessment.blood_pressure_diastolic || 'N/A' %></div>
                        <div class="vital-sign-label">Blood Pressure (mmHg)</div>
                    </div>
                    <div class="vital-sign-card">
                        <div class="vital-sign-value"><%= nursingAssessment.respiratory_rate_per_min || 'N/A' %></div>
                        <div class="vital-sign-label">Respiratory Rate (/min)</div>
                    </div>
                    <div class="vital-sign-card">
                        <div class="vital-sign-value"><%= nursingAssessment.oxygen_saturation_percent || 'N/A' %></div>
                        <div class="vital-sign-label">SpO2 (%)</div>
                    </div>
                    <div class="vital-sign-card">
                        <div class="vital-sign-value"><%= nursingAssessment.blood_sugar_mg_dl || 'N/A' %></div>
                        <div class="vital-sign-label">Blood Sugar (mg/dL)</div>
                    </div>
                </div>
            </div>

            <!-- Physical Assessment -->
            <div class="info-grid">
                <div class="info-row">
                    <div class="info-cell info-label">General Condition:</div>
                    <div class="info-cell"><%= nursingAssessment.general_condition || 'N/A' %></div>
                    <div class="info-cell info-label">Consciousness Level:</div>
                    <div class="info-cell"><%= nursingAssessment.consciousness_level || 'N/A' %></div>
                </div>
                <div class="info-row">
                    <div class="info-cell info-label">Skin Condition:</div>
                    <div class="info-cell"><%= nursingAssessment.skin_condition || 'N/A' %></div>
                    <div class="info-cell info-label">Mobility Status:</div>
                    <div class="info-cell"><%= nursingAssessment.mobility_status || 'N/A' %></div>
                </div>
                <div class="info-row">
                    <div class="info-cell info-label">Psychological Problem:</div>
                    <div class="info-cell"><%= nursingAssessment.psychological_problem || 'None' %></div>
                    <div class="info-cell info-label">Smoker:</div>
                    <div class="info-cell"><%= nursingAssessment.is_smoker ? 'Yes' : 'No' %></div>
                </div>
                <div class="info-row">
                    <div class="info-cell info-label">Allergies:</div>
                    <div class="info-cell"><%= nursingAssessment.has_allergies ? 'Yes' : 'No' %></div>
                    <div class="info-cell info-label">Diet Type:</div>
                    <div class="info-cell"><%= nursingAssessment.diet_type || 'N/A' %></div>
                </div>
                <div class="info-row">
                    <div class="info-cell info-label">Weight:</div>
                    <div class="info-cell"><%= nursingAssessment.weight_kg || 'N/A' %> kg</div>
                    <div class="info-cell info-label">Height:</div>
                    <div class="info-cell"><%= nursingAssessment.height_cm || 'N/A' %> cm</div>
                </div>
            </div>

            <!-- Pain Assessment -->
            <% if (nursingAssessment.pain_intensity) { %>
                <div style="margin: 20px 0;">
                    <strong>Pain Assessment:</strong>
                    <div class="info-grid">
                        <div class="info-row">
                            <div class="info-cell info-label">Pain Intensity:</div>
                            <div class="info-cell"><%= nursingAssessment.pain_intensity %>/10</div>
                            <div class="info-cell info-label">Pain Location:</div>
                            <div class="info-cell"><%= nursingAssessment.pain_location || 'N/A' %></div>
                        </div>
                        <div class="info-row">
                            <div class="info-cell info-label">Action Taken:</div>
                            <div class="info-cell" colspan="3"><%= nursingAssessment.action_taken || 'N/A' %></div>
                        </div>
                    </div>
                </div>
            <% } %>

            <!-- Nurse Signature -->
            <% if (nursingAssessment.nurse_signature) { %>
                <div style="margin: 30px 0; text-align: center; page-break-inside: avoid;">
                    <strong>Nurse Signature:</strong>
                    <div style="margin: 20px 0; padding: 20px; border: 2px solid #dee2e6; border-radius: 5px; background-color: #f8f9fa;">
                        <img src="<%= nursingAssessment.nurse_signature %>" alt="Nurse Signature" style="max-height: 80px; max-width: 300px;">
                    </div>
                    <div style="margin-top: 10px; font-size: 12px; color: #495057;">
                        Signed by: <%= nursingAssessment.assessed_by_name || 'Unknown' %> |
                        Date: <%= nursingAssessment.assessed_at ? new Date(nursingAssessment.assessed_at).toLocaleString() : 'Not specified' %>
                    </div>
                </div>
            <% } %>
        <% } %>

        <!-- Radiology Assessment -->
        <% if (radiologyAssessment) { %>
            <div class="section-title page-break">
                <i class="fas fa-x-ray me-2"></i>Radiology Assessment
            </div>

            <div class="info-grid">
                <div class="info-row">
                    <div class="info-cell info-label">Assessed By:</div>
                    <div class="info-cell"><%= radiologyAssessment.assessed_by_name || 'Unknown' %></div>
                    <div class="info-cell info-label">Assessment Date:</div>
                    <div class="info-cell"><%= radiologyAssessment.assessed_at ? new Date(radiologyAssessment.assessed_at).toLocaleString() : 'Not specified' %></div>
                </div>
                <div class="info-row">
                    <div class="info-cell info-label">Treating Physician:</div>
                    <div class="info-cell"><%= radiologyAssessment.treating_physician || 'N/A' %></div>
                    <div class="info-cell info-label">Department:</div>
                    <div class="info-cell"><%= radiologyAssessment.department || 'N/A' %></div>
                </div>
                <div class="info-row">
                    <div class="info-cell info-label">Modality:</div>
                    <div class="info-cell"><%= radiologyAssessment.modality || 'N/A' %></div>
                    <div class="info-cell info-label">Body Region:</div>
                    <div class="info-cell"><%= radiologyAssessment.body_region || 'N/A' %></div>
                </div>
            </div>

            <div class="info-grid">
                <div class="info-row">
                    <div class="info-cell info-label">Diagnosis:</div>
                    <div class="info-cell" colspan="3"><%= radiologyAssessment.diagnosis || 'N/A' %></div>
                </div>
                <div class="info-row">
                    <div class="info-cell info-label">Reason for Study:</div>
                    <div class="info-cell" colspan="3"><%= radiologyAssessment.reason_for_study || 'N/A' %></div>
                </div>
            </div>

            <% if (radiologyAssessment.findings) { %>
                <div style="margin: 20px 0;">
                    <strong>Findings:</strong>
                    <div class="assessment-content">
                        <%= radiologyAssessment.findings.replace(/\n/g, '<br>') %>
                    </div>
                </div>
            <% } %>

            <% if (radiologyAssessment.impression) { %>
                <div style="margin: 20px 0;">
                    <strong>Impression:</strong>
                    <div class="assessment-content">
                        <%= radiologyAssessment.impression.replace(/\n/g, '<br>') %>
                    </div>
                </div>
            <% } %>

            <% if (radiologyAssessment.recommendations) { %>
                <div style="margin: 20px 0;">
                    <strong>Recommendations:</strong>
                    <div class="assessment-content">
                        <%= radiologyAssessment.recommendations.replace(/\n/g, '<br>') %>
                    </div>
                </div>
            <% } %>

            <!-- Physician Signature -->
            <% if (radiologyAssessment.physician_signature) { %>
                <div style="margin: 30px 0; text-align: center; page-break-inside: avoid;">
                    <strong>Physician Signature:</strong>
                    <div style="margin: 20px 0; padding: 20px; border: 2px solid #dee2e6; border-radius: 5px; background-color: #f8f9fa;">
                        <img src="<%= radiologyAssessment.physician_signature %>" alt="Physician Signature" style="max-height: 80px; max-width: 300px;">
                    </div>
                    <div style="margin-top: 10px; font-size: 12px; color: #495057;">
                        Signed by: <%= radiologyAssessment.assessed_by_name || 'Unknown' %> |
                        Date: <%= radiologyAssessment.assessed_at ? new Date(radiologyAssessment.assessed_at).toLocaleString() : 'Not specified' %>
                    </div>
                </div>
            <% } %>
        <% } %>

        <!-- Footer -->
        <div class="footer-section">
            <div>
                <strong>Al-Shorouk Radiology Management System</strong><br>
                Visit Report Generated on <%= new Date().toLocaleString() %><br>
                Visit ID: <%= visit.visit_id %> | Patient: <%= visit.full_name %>
            </div>
        </div>
    </div>

    <script>
        // Auto-print when page loads (optional)
        // window.onload = function() {
        //     window.print();
        // };
    </script>
</body>
</html>